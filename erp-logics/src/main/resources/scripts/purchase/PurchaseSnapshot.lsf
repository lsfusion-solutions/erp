MODULE PurchaseSnapshot;

REQUIRE PurchaseLedger, StockSnapshot;

NAMESPACE Purchase;


//-- Sku
purchaseQuantity 'Кол-во закупка' = DATA NUMERIC[14,3] (Sku, Stock, Snapshot);
purchaseNetWeight 'Вес закупка' = DATA NUMERIC[14,3] (Sku, Stock, Snapshot);
purchaseSum 'Сумма закупка' = DATA NUMERIC[16,2] (Sku, Stock, Snapshot);

purchaseCost 'Себестоимость закупка' = DATA NUMERIC[16,2] (Sku, Stock, Snapshot);
purchaseVATSupplier 'НДС поставщика закупка' = DATA NUMERIC[16,2] (Sku, Stock, Snapshot);
purchaseCostVATSupplier 'С/С с НДС закупка' = purchaseVATSupplier(Sku sku, Stock stock, Snapshot snapshot) (+)
                                                                    purchaseCost(sku, stock, snapshot);
//-- группа/склад       
purchaseQuantity 'Кол-во закупка' (group, stock, snapshot) =
    GROUP SUM purchaseQuantity (Sku sku, Stock stock, Snapshot snapshot) IF isParent(SkuGroup group, sku)
        BY group, stock, snapshot MATERIALIZED;
purchaseNetWeight 'Вес закупка' (group, stock, snapshot) =
    GROUP SUM purchaseNetWeight (Sku sku, Stock stock, Snapshot snapshot) IF isParent(SkuGroup group, sku)
        BY group, stock, snapshot MATERIALIZED;        
purchaseSum 'Сумма закупка' (group, stock, snapshot) =
    GROUP SUM purchaseSum (Sku sku, Stock stock, Snapshot snapshot) IF isParent(SkuGroup group, sku)
        BY group, stock, snapshot MATERIALIZED; 
purchaseCost 'Себестоимость закупка' (group, stock, snapshot) =
    GROUP SUM purchaseCost (Sku sku, Stock stock, Snapshot snapshot) IF isParent(SkuGroup group, sku)
        BY group, stock, snapshot MATERIALIZED;         
purchaseVATSupplier 'НДС поставщика закупка' (group, stock, snapshot) =
    GROUP SUM purchaseVATSupplier (Sku sku, Stock stock, Snapshot snapshot) IF isParent(SkuGroup group, sku)
        BY group, stock, snapshot MATERIALIZED;                 
purchaseCostVATSupplier 'С/С с НДС закупка' = purchaseVATSupplier(SkuGroup group, Stock stock, Snapshot snapshot) (+)
                                                                         purchaseCost(group, stock, snapshot);               
        
//-- группа          
purchaseQuantity 'Кол-во закупка' (group, snapshot) =
    GROUP SUM purchaseQuantity (SkuGroup group, Stock stock, Snapshot snapshot)  BY group, snapshot; 
purchaseNetWeight 'Вес закупка' (group, snapshot) =
    GROUP SUM purchaseNetWeight (SkuGroup group, Stock stock, Snapshot snapshot)  BY group, snapshot;     
purchaseSum 'Сумма закупка' (group, snapshot) =
    GROUP SUM purchaseSum (SkuGroup group, Stock stock, Snapshot snapshot) BY group, snapshot;   
purchaseCost 'Себестоимость закупка' (group, snapshot) =
    GROUP SUM purchaseCost (SkuGroup group, Stock stock, Snapshot snapshot) BY group, snapshot;             
purchaseVATSupplier 'НДС поставщика закупка' (group, snapshot) =
    GROUP SUM purchaseVATSupplier (SkuGroup group, Stock stock, Snapshot snapshot) BY group, snapshot;  
purchaseCostVATSupplier 'С/С с НДС закупка' = purchaseVATSupplier(SkuGroup group,  Snapshot snapshot) (+)
                                                                     purchaseCost(group, snapshot);                    

//--По складам
purchaseQuantity 'Кол-во закупка' (stock, snapshot) =
    GROUP SUM purchaseQuantity (Sku sku, Stock stock, Snapshot snapshot)  BY stock, snapshot; 
purchaseNetWeight 'Вес закупка' (stock, snapshot) =
    GROUP SUM purchaseNetWeight (Sku sku, Stock stock, Snapshot snapshot)  BY stock, snapshot;     
purchaseSum 'Сумма закупка' (stock, snapshot) =
    GROUP SUM purchaseSum (Sku sku, Stock stock, Snapshot snapshot) BY stock, snapshot;  
purchaseCost 'Себестоимость закупка' (stock, snapshot) =
    GROUP SUM purchaseCost (Sku sku, Stock stock, Snapshot snapshot) BY stock, snapshot;  
purchaseVATSupplier 'НДС поставщика  закупка' (stock, snapshot) =
    GROUP SUM purchaseVATSupplier (Sku sku, Stock stock, Snapshot snapshot) BY stock, snapshot;    
purchaseCostVATSupplier 'С/С с НДС закупка' = purchaseVATSupplier(Stock stock, Snapshot snapshot) (+)
                                                                         purchaseCost(stock, snapshot);            
           
//-- Sku
purchaseQuantity 'Кол-во закупка' = DATA NUMERIC[14,3] (Sku, Stock, Snapshot, DATE);
purchaseNetWeight 'Вес закупка' = DATA NUMERIC[14,3] (Sku, Stock, Snapshot, DATE);
purchaseSum 'Сумма закупка' = DATA NUMERIC[16,2] (Sku, Stock, Snapshot, DATE);  
 
purchaseCost 'Себестоимость закупка' = DATA NUMERIC[16,2] (Sku, Stock, Snapshot, DATE);   
purchaseVATSupplier 'НДС поставщика закупка' = DATA NUMERIC[16,2] (Sku, Stock, Snapshot, DATE);  
purchaseCostVATSupplier 'С/С с НДС закупка' = purchaseVATSupplier(Sku sku, Stock stock, Snapshot snapshot, DATE date) (+)
                                                                    purchaseCost(sku, stock, snapshot, date);  
//--По складам на дату     
purchaseQuantity 'Кол-во закупка' (stock, snapshot, date) =
    GROUP SUM purchaseQuantity (Sku sku, Stock stock, Snapshot snapshot, DATE date)  BY stock, snapshot, date; 
purchaseNetWeight 'Вес закупка' (stock, snapshot, date) =
    GROUP SUM purchaseNetWeight (Sku sku, Stock stock, Snapshot snapshot, DATE date)  BY stock, snapshot, date;     
purchaseSum 'Сумма закупка' (stock, snapshot, date) =
    GROUP SUM purchaseSum (Sku sku, Stock stock, Snapshot snapshot, DATE date) BY stock, snapshot, date;   
purchaseCost 'Себестоимость закупка' (stock, snapshot, date) =
    GROUP SUM purchaseCost (Sku sku, Stock stock, Snapshot snapshot, DATE date) BY stock, snapshot, date;      
purchaseVATSupplier 'НДС поставщика закупка' (stock, snapshot, date) =
    GROUP SUM purchaseVATSupplier (Sku sku, Stock stock, Snapshot snapshot, DATE date) BY stock, snapshot, date;  
purchaseCostVATSupplier 'С/С с НДС закупка' = purchaseVATSupplier(Stock group, Snapshot stock, DATE date) (+)
                                                                     purchaseCost(group, stock, date);
                                                                                  
namePurchaseQuantity (Stock st) = CONCAT ' ', name(st), ' (кол-во закупка)';
namePurchaseNetWeight (Stock st) = CONCAT ' ', name(st), ' (вес закупка)';
namePurchaseSum (Stock st) = CONCAT ' ', name(st), ' (сумма закупка)';  
namePurchaseCost (Stock st) = CONCAT ' ', name(st), ' (себестоимость закупка)';  
namePurchaseVATSupplier (Stock st) = CONCAT ' ', name(st), ' (НДС поставщика закупка)';  
namePurchaseCostVATSupplier (Stock st) = CONCAT ' ', name(st), ' (c/c с НДС закупка)';    
isPurchase 'Закупка' = DATA BOOLEAN (Snapshot) IN evidence;

isPurchase 'Закупка' = DATA BOOLEAN (SnapshotType);

//-- Batch
purchaseQuantity 'Кол-во закупка' = DATA NUMERIC[14,3] (Batch, Stock, Snapshot);
purchaseNetWeight 'Вес закупка' = DATA NUMERIC[14,3] (Batch, Stock, Snapshot);
purchaseSum 'Сумма закупка' = DATA NUMERIC[16,2] (Batch, Stock, Snapshot);

purchaseCost 'Себестоимость закупка' = DATA NUMERIC[16,2] (Batch, Stock, Snapshot);
purchaseVATSupplier 'НДС поставщика закупка' = DATA NUMERIC[16,2] (Batch, Stock, Snapshot);
purchaseCostVATSupplier 'С/С с НДС закупка' = purchaseVATSupplier(Batch batch, Stock stock, Snapshot snapshot) (+)
                                                                    purchaseCost(batch, stock, snapshot);

EXTEND FORM snapshotType
    PROPERTIES (t) isPurchase
;
DESIGN snapshotType {
    row6 {
        MOVE PROPERTY(isPurchase(t));                                            
    } 
}
EXTEND FORM snapshotTypes
    PROPERTIES (t) READONLY  isPurchase
;
@deriveDocumentSnapshotProperty(isPurchase);      
                 
//-- Расширяем ACTION  
overTakeSkuFromTo(Snapshot snapshot, DATE dateFrom, DATE dateTo) += {
    IF isPurchase(snapshot) THEN {
        IF isDate(snapshot) THEN {
            purchaseQuantity(Sku sku, Stock stock, snapshot, DATE date) <- NULL;
            purchaseQuantity(Sku sku, Stock stock, snapshot, DATE date) <- NUMERIC[14,3](quantityPurchase(sku, stock, date)) 
                WHERE include(snapshot, stock) AND include(snapshot, sku) AND date AS DATE AND date >= (dateFrom AS DATE) 
                    AND date <= (dateTo AS DATE) AND quantityPurchase(sku, stock, date) AND isQuantity(snapshot);
            
            purchaseNetWeight(Sku sku, Stock stock, snapshot, DATE date) <- NULL;
            purchaseNetWeight(Sku sku, Stock stock, snapshot, DATE date) <- NUMERIC[14,3](quantityPurchase(sku, stock, date)*overNetWeight(sku)) 
                WHERE include(snapshot, stock) AND include(snapshot, sku) AND date AS DATE AND date >= (dateFrom AS DATE) 
                    AND date <= (dateTo AS DATE) AND quantityPurchase(sku, stock, date) AND isNetWeight(snapshot);
            
            purchaseSum(Sku sku, Stock stock, snapshot, DATE date) <- NULL;                            
            purchaseSum(Sku sku, Stock stock, snapshot, DATE date) <- NUMERIC[16,2](sumPurchase(sku, stock, date)) 
                WHERE include(snapshot, stock) AND include(snapshot, sku) AND date AS DATE AND date >= (dateFrom AS DATE) 
                    AND date <= (dateTo AS DATE) AND sumPurchase(sku, stock, date) AND isSum(snapshot);  
                
            purchaseCost(Sku sku, Stock stock, snapshot, DATE date) <- NULL; 
            purchaseCost(Sku sku, Stock stock, snapshot, DATE date) <- NUMERIC[16,2](costSumPurchase(sku, stock, date)) 
                WHERE include(snapshot, stock) AND include(snapshot, sku) AND date AS DATE AND date >= (dateFrom AS DATE) 
                    AND date <= (dateTo AS DATE) AND costSumPurchase(sku, stock, date) AND isCost(snapshot);   
                                       
            purchaseVATSupplier(Sku sku, Stock stock, snapshot, DATE date) <- NULL;
            purchaseVATSupplier(Sku sku, Stock stock, snapshot, DATE date) <- NUMERIC[16,2](sumVATPurchase(sku, stock, date)) 
                WHERE include(snapshot, stock) AND include(snapshot, sku) AND date AS DATE AND date >= (dateFrom AS DATE) 
                    AND date <= (dateTo AS DATE) AND sumVATPurchase(sku, stock, date) AND isVATSupplier(snapshot);                      
                     
        }
        purchaseQuantity(Sku sku, Stock stock, snapshot) <- NULL;
        purchaseQuantity(Sku sku, Stock stock, snapshot) <- NUMERIC[14,3](quantityPurchase(sku, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku) AND isQuantity(snapshot) AND quantityPurchase(sku, stock, dateFrom, dateTo);
        
        purchaseNetWeight(Sku sku, Stock stock, snapshot) <- NULL;    
        purchaseNetWeight(Sku sku, Stock stock, snapshot) <- NUMERIC[14,3](quantityPurchase(sku, stock, dateFrom, dateTo)*overNetWeight(sku)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku) AND isNetWeight(snapshot) AND quantityPurchase(sku, stock, dateFrom, dateTo);
        
        purchaseSum(Sku sku, Stock stock, snapshot) <- NULL;                
        purchaseSum(Sku sku, Stock stock, snapshot) <- NUMERIC[16,2](sumPurchase(sku, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku) AND isSum(snapshot) AND sumPurchase(sku, stock, dateFrom, dateTo);   
        
        purchaseCost(Sku sku, Stock stock, snapshot) <- NULL;    
        purchaseCost(Sku sku, Stock stock, snapshot) <- NUMERIC[16,2](costSumPurchase(sku, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku) AND isCost(snapshot) AND costSumPurchase(sku, stock, dateFrom, dateTo);  
        
        purchaseVATSupplier(Sku sku, Stock stock, snapshot) <- NULL;                  
        purchaseVATSupplier(Sku sku, Stock stock, snapshot) <- NUMERIC[16,2](sumVATPurchase(sku, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku) AND isVATSupplier(snapshot) AND sumVATPurchase(sku, stock, dateFrom, dateTo);   
                         
        //batch
        purchaseQuantity(Batch batch, Stock stock, snapshot) <- NULL;
        purchaseQuantity(Batch batch, Stock stock, snapshot) <- NUMERIC[14,3](quantityPurchase(batch, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku(batch)) AND isQuantity(snapshot) AND quantityPurchase(batch, stock, dateFrom, dateTo);
        
        purchaseNetWeight(Batch batch, Stock stock, snapshot) <- NULL;    
        purchaseNetWeight(Batch batch, Stock stock, snapshot) <- NUMERIC[14,3](quantityPurchase(batch, stock, dateFrom, dateTo)*overNetWeight(sku(batch))) 
            WHERE include(snapshot, stock) AND include(snapshot, sku(batch)) AND isNetWeight(snapshot) AND quantityPurchase(batch, stock, dateFrom, dateTo);
        
        purchaseSum(Batch batch, Stock stock, snapshot) <- NULL;                
        purchaseSum(Batch batch, Stock stock, snapshot) <- NUMERIC[16,2](sumPurchase(batch, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku(batch)) AND isSum(snapshot) AND sumPurchase(batch, stock, dateFrom, dateTo);   
        
        purchaseCost(Batch batch, Stock stock, snapshot) <- NULL;    
        purchaseCost(Batch batch, Stock stock, snapshot) <- NUMERIC[16,2](costSumPurchase(batch, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku(batch)) AND isCost(snapshot) AND costSumPurchase(batch, stock, dateFrom, dateTo);  
        
        purchaseVATSupplier(Batch batch, Stock stock, snapshot) <- NULL;                  
        purchaseVATSupplier(Batch batch, Stock stock, snapshot) <- NUMERIC[16,2](sumVATPurchase(batch, stock, dateFrom, dateTo)) 
            WHERE include(snapshot, stock) AND include(snapshot, sku(batch)) AND isVATSupplier(snapshot) AND sumVATPurchase(batch, stock, dateFrom, dateTo);                                                                             
                         
    }    
}; 
//-- SHOWIF
isQuantityPurchase= isQuantity(Snapshot snapshot) AND isPurchase(snapshot);
isNetWeightPurchase= isNetWeight(Snapshot snapshot) AND isPurchase(snapshot);
isSumPurchase= isSum(Snapshot snapshot) AND isPurchase(snapshot);
isCostPurchase= isCost(Snapshot snapshot) AND isPurchase(snapshot);
isVATSupplierPurchase= isVATSupplier(Snapshot snapshot) AND isPurchase(snapshot);
isCostVATSupplierPurchase= isCostVATSupplier(Snapshot snapshot) AND isPurchase(snapshot);
//--
isQuantityPurchaseDate= isQuantity(Snapshot snapshot) AND isPurchase(snapshot) AND isDate(snapshot);
isNetWeightPurchaseDate= isNetWeight(Snapshot snapshot) AND isPurchase(snapshot) AND isDate(snapshot);
isSumPurchaseDate= isSum(Snapshot snapshot) AND isPurchase(snapshot) AND isDate(snapshot);
isCostPurchaseDate= isCost(Snapshot snapshot) AND isPurchase(snapshot) AND isDate(snapshot);
isVATSupplierPurchaseDate= isVATSupplier(Snapshot snapshot) AND isPurchase(snapshot) AND isDate(snapshot);
isCostVATSupplierPurchaseDate= isCostVATSupplier(Snapshot snapshot) AND isPurchase(snapshot) AND isDate(snapshot);

EXTEND FORM snapshot
    PROPERTIES(r) BACKGROUND hintPurchaseBackground() isPurchase
//--sku  
    PROPERTIES(s,st,r) AFTER netWeightB(s, st, r) BACKGROUND hintPurchaseBackground()
                       purchaseQuantity SHOWIF isQuantityPurchase(r), 
                       purchaseSum SHOWIF isSumPurchase(r),
                       purchaseCost SHOWIF isCostPurchase(r),
                       purchaseVATSupplier SHOWIF isVATSupplierPurchase(r),
                       purchaseCostVATSupplier SHOWIF isCostVATSupplierPurchase(r),
                       purchaseNetWeight SHOWIF isNetWeightPurchase(r)
                       
//--sku на дату 
    PROPERTIES(s3,st3,r,d3) AFTER netWeightB(s3,st3,r,d3) BACKGROUND hintPurchaseBackground()
                       purchaseQuantity SHOWIF isQuantityPurchaseDate(r), 
                       purchaseSum SHOWIF isSumPurchaseDate(r),
                       purchaseCost SHOWIF isCostPurchaseDate(r),
                       purchaseVATSupplier SHOWIF isVATSupplierPurchaseDate(r),
                       purchaseCostVATSupplier SHOWIF isCostVATSupplierPurchaseDate(r),
                       purchaseNetWeight SHOWIF isNetWeightPurchaseDate(r)  
                                                                  
//--По складам на дату 
    PROPERTIES(st4,r,d4) BACKGROUND hintPurchaseBackground() AFTER netWeightB(st4,r,d4)
                       purchaseQuantity COLUMNS 'g' (st4) HEADER namePurchaseQuantity(st4) SHOWIF isQuantityPurchaseDate(r), 
                       purchaseSum COLUMNS 'g' (st4) HEADER namePurchaseSum(st4) SHOWIF isSumPurchaseDate(r),
                       purchaseCost COLUMNS 'g' (st4) HEADER namePurchaseCost(st4) SHOWIF isCostPurchaseDate(r),
                       purchaseVATSupplier COLUMNS 'g' (st4) HEADER namePurchaseVATSupplier(st4) SHOWIF isVATSupplierPurchaseDate(r),
                       purchaseCostVATSupplier COLUMNS 'g' (st4) HEADER namePurchaseCostVATSupplier(st4) SHOWIF isCostVATSupplierPurchaseDate(r),
                       purchaseNetWeight COLUMNS 'g' (st4) HEADER namePurchaseNetWeight(st4) SHOWIF isNetWeightPurchaseDate(r) 
                                                                                         
//-- По группам                           
    PROPERTIES(sk1,r)  READONLY AFTER netWeightB(sk1,r) BACKGROUND hintPurchaseBackground() 
                       purchaseQuantity SHOWIF isQuantityPurchase(r), 
                       purchaseSum SHOWIF isSumPurchase(r),
                       purchaseCost SHOWIF isCostPurchase(r),
                       purchaseVATSupplier SHOWIF isVATSupplierPurchase(r),
                       purchaseCostVATSupplier SHOWIF isCostVATSupplierPurchase(r),
                       purchaseNetWeight SHOWIF isNetWeightPurchase(r)
    PROPERTIES(skg,r)  READONLY AFTER netWeightB(skg,r) BACKGROUND hintPurchaseBackground() 
                       purchaseQuantity SHOWIF isQuantityPurchase(r), 
                       purchaseSum SHOWIF isSumPurchase(r),
                       purchaseCost SHOWIF isCostPurchase(r),
                       purchaseVATSupplier SHOWIF isVATSupplierPurchase(r),
                       purchaseCostVATSupplier SHOWIF isCostVATSupplierPurchase(r),
                       purchaseNetWeight SHOWIF isNetWeightPurchase(r)
//-- По складам                           
    PROPERTIES(ts1,r)  READONLY AFTER netWeightB(ts1,r) BACKGROUND hintPurchaseBackground()                         
                       purchaseQuantity SHOWIF isQuantityPurchase(r), 
                       purchaseSum SHOWIF isSumPurchase(r),
                       purchaseCost SHOWIF isCostPurchase(r),
                       purchaseVATSupplier SHOWIF isVATSupplierPurchase(r),
                       purchaseCostVATSupplier SHOWIF isCostVATSupplierPurchase(r),
                       purchaseNetWeight SHOWIF isNetWeightPurchase(r)
                       
                       
//--batch  
    PROPERTIES(bt,ss,r) AFTER netWeightB(bt,ss,r) BACKGROUND hintPurchaseBackground()
                       purchaseQuantity SHOWIF isQuantityPurchase(r), 
                       purchaseSum SHOWIF isSumPurchase(r),
                       purchaseCost SHOWIF isCostPurchase(r),
                       purchaseVATSupplier SHOWIF isVATSupplierPurchase(r),
                       purchaseCostVATSupplier SHOWIF isCostVATSupplierPurchase(r),
                       purchaseNetWeight SHOWIF isNetWeightPurchase(r)                       
;
DESIGN snapshot {
    row6 {
        MOVE PROPERTY(isPurchase(r));                                            
    } 
}

EXTEND FORM snapshots 
        PROPERTIES(r) READONLY BACKGROUND hintPurchaseBackground() isPurchase
;
 
