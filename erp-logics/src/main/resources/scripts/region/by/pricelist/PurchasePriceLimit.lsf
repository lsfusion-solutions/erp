MODULE PurchasePriceLimit;

REQUIRE PricingPriceLimit, PricingPurchase;

NAMESPACE Purchase;

//------------------ Предельные надбавки ----------------------//

@defineDocumentInterfaceProperty (invoice, showLimitPrice, 'Предельная надбавка');
@defineDocumentInterfaceDetailMarkupPrefix (invoice, limit, ' предельная');

WHEN SESSION FORMS userInvoice 
             (CHANGED(customerStock(UserInvoiceDetail detail)) OR
              CHANGED(sku(detail)) OR 
              SET(showLimitPrice(detail)))
             AND showLimitPrice(detail) DO {
    limitMarkup(detail) <- markup(priceLimitPriceListType(customerStock(detail)), sku(detail));
}

//----------------------------------------------- Операции -----------------------------------------------------//

// Записываем необходимо ли показывать предельную надбавку по умолчанию из операции расценки, заданной для операции закупка
showLimitPrice (UserInvoice invoice) <- showLimitPrice(pricingOperation(operation(invoice)))
    WHEN CHANGED(operation(invoice));

showIfLimitPrice = showLimitPrice (UserInvoice invoice) AND createPricing(invoice);

EXTEND FORM userInvoice
    PROPERTIES(i) showLimitPrice SHOWIF createPricing(i) BACKGROUND backgroundRetail(i)
    PROPERTIES(pd) SHOWIF showIfLimitPrice(i) BEFORE retailMarkup(pd) limitMarkup BACKGROUND backgroundRetail(i)
;
DESIGN userInvoice{
    headerCreatePricing {
        MOVE PROPERTY (showLimitPrice(i));

    }
}

EXTEND FORM invoices
    PROPERTIES(d) READONLY SHOWIF showLimitPrice(i) BEFORE retailMarkup(d) limitMarkup BACKGROUND backgroundRetail(i)
;

// Имплементим для расчета оптимальной розничной цены

overLimitBasePrice = ABSTRACT NUMERIC[16,4] (UserInvoiceDetail);
limitBasePrice(UserInvoiceDetail d) = OVERRIDE price(d), overLimitBasePrice(d);
 
limitMarkupPrice (UserInvoiceDetail d) =
                                           round(
                                                [= (X+Y)*(Z+100.0)/100.0](
                                                    limitBasePrice(d),
                                                    limitMarkup(d),
                                                    valueRetailVAT(d)), roundCondition(priceLimitPriceListType(customerStock(d)), sku(d)));

limitPrice (UserInvoiceDetail detail) =
                                       round(
                                           [= X*(Y+100.0)*(Z+100.0)/10000.0](
                                                    limitBasePrice(detail),
                                                    limitMarkup(detail),
                                                    valueRetailVAT(detail)), roundCondition(priceLimitPriceListType(customerStock(detail)), sku(detail)));

WHEN SESSION FORMS userInvoice GOAFTER retailPrice[UserInvoiceDetail] 
            (SETCHANGED(retailPrice(UserInvoiceDetail d)) OR CHANGED(limitMarkup(d))) AND //  вообще в событии должно быть это условие, но тогда не всегда срабатывает (см. skype с Vitalur за 10.07) 
             showLimitPrice(d) AND limitMarkup(d) > 3000 AND limitMarkup(d) < retailPrice(d) DO {
    retailPrice(d) <- limitMarkup(d);
    retailMarkup(d) <- calcRetailMarkup(d);;
}

WHEN SESSION FORMS userInvoice GOAFTER retailPrice[UserInvoiceDetail] 
            (SETCHANGED(retailPrice(UserInvoiceDetail d)) OR CHANGED(limitBasePrice(d)) OR CHANGED(limitMarkup(d))) AND //  вообще в событии должно быть это условие, но тогда не всегда срабатывает (см. skype с Vitalur за 10.07) 
             showLimitPrice(d) AND limitMarkup(d) <= 3000 AND limitMarkup(d) > 100 AND limitMarkupPrice(d) < retailPrice(d) DO {
    retailPrice(d) <- limitMarkupPrice(d);
    retailMarkup(d) <- calcRetailMarkup(d);
}

WHEN SESSION FORMS userInvoice GOAFTER retailPrice[UserInvoiceDetail] 
            (SETCHANGED(retailPrice(UserInvoiceDetail d)) OR CHANGED(limitBasePrice(d)) OR CHANGED(limitMarkup(d))) AND //  вообще в событии должно быть это условие, но тогда не всегда срабатывает (см. skype с Vitalur за 10.07) 
             showLimitPrice(d) AND limitMarkup(d) <= 100 AND limitPrice(d) < retailPrice(d) DO {
    retailPrice(d) <- limitPrice(d);
    retailMarkup(d) <- calcRetailMarkup(d);
}

// todo : перед деноминацией
//WHEN SESSION FORMS userInvoice GOAFTER retailPrice[UserInvoiceDetail] 
//            (SETCHANGED(retailPrice(UserInvoiceDetail d)) OR CHANGED(limitMarkup(d))) AND //  вообще в событии должно быть это условие, но тогда не всегда срабатывает (см. skype с Vitalur за 10.07) 
//             showLimitPrice(d) AND limitMarkup(d) > 0.3 AND limitMarkup(d) <= 1 AND limitMarkup(d) < retailPrice(d) DO {
//    retailPrice(d) <- limitMarkup(d);
//    retailMarkup(d) <- calcRetailMarkup(d);;
//}
//
//WHEN SESSION FORMS userInvoice GOAFTER retailPrice[UserInvoiceDetail] 
//            (SETCHANGED(retailPrice(UserInvoiceDetail d)) OR CHANGED(limitBasePrice(d)) OR CHANGED(limitMarkup(d))) AND //  вообще в событии должно быть это условие, но тогда не всегда срабатывает (см. skype с Vitalur за 10.07) 
//             showLimitPrice(d) AND limitMarkup(d) <= 0.3 AND limitMarkupPrice(d) < retailPrice(d) DO {
//    retailPrice(d) <- limitMarkupPrice(d);
//    retailMarkup(d) <- calcRetailMarkup(d);
//}
//
//WHEN SESSION FORMS userInvoice GOAFTER retailPrice[UserInvoiceDetail] 
//            (SETCHANGED(retailPrice(UserInvoiceDetail d)) OR CHANGED(limitBasePrice(d)) OR CHANGED(limitMarkup(d))) AND //  вообще в событии должно быть это условие, но тогда не всегда срабатывает (см. skype с Vitalur за 10.07) 
//             showLimitPrice(d) AND limitMarkup(d) > 1 AND limitPrice(d) < retailPrice(d) DO {
//    retailPrice(d) <- limitPrice(d);
//    retailMarkup(d) <- calcRetailMarkup(d);
//}

showLimitPrice(InvoicePricing pricing) += showLimitPrice(invoice(pricing));
limitMarkup(InvoicePricingDetail detail) += limitMarkup(invoiceDetail(detail));

