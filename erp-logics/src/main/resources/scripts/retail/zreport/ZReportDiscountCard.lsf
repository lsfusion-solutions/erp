MODULE ZReportDiscountCard;

REQUIRE ZReport, DiscountCard;

NAMESPACE ZReport;

discountCard (receipt) = DATA DiscountCard (Receipt) INDEXED;
seriesNumberDiscountCard (Receipt receipt) = seriesNumber(discountCard(receipt));
discountCard (ReceiptSaleDetail d) = discountCard(receipt(d));
discountCard (ReceiptReturnDetail d) = discountCard(receipt(d));
discountCard (ReceiptDetail d) = discountCard(receipt(d));
idDiscountCard 'Код дисконтной карты' (ReceiptDetail d) = id(discountCard(d));

CONSTRAINT dateTo(discountCard(Receipt receipt)) < date(receipt) CHECKED BY discountCard[Receipt] MESSAGE 'Закончился срок действия карты';

numberDiscountCard 'Номер дисконтной карты' (Receipt receipt) = seriesNumber(discountCard(receipt)) IN receiptDiscount;
nameLegalEntityDiscountCard 'Держатель дисконтной карты' (Receipt receipt) = nameLegalEntity(discountCard(receipt)) IN receiptDiscount MINCHARWIDTH 30 PREFCHARWIDTH 40;
numberDiscountCard 'Номер дисконтной карты' (ReceiptDetail receiptDetail) = numberDiscountCard(receipt(receiptDetail));
nameLegalEntityDiscountCard 'Держатель дисконтной карты' (ReceiptDetail receiptDetail) = nameLegalEntityDiscountCard(receipt(receiptDetail)) MINCHARWIDTH 30 PREFCHARWIDTH 40;

countReceiptsDiscountCard 'Кол-во чеков по дисконтным картам в Z-отчете' (zReport) = GROUP SUM 1 IF discountCard(Receipt receipt)  
    BY zReport(receipt) PERSISTENT IN documentSum;
    
EXTEND FORM zReport
    PROPERTIES(b) AFTER nameEmployee(b) numberDiscountCard, nameLegalEntityDiscountCard
;
EXTEND FORM zReports
    PROPERTIES(b) READONLY AFTER nameEmployee(b) numberDiscountCard, nameLegalEntityDiscountCard 
;

//--Накопленные суммы

posSum 'Сумма продаж' (discountCard) = GROUP SUM sumReceiptDetail (Receipt receipt) BY discountCard(receipt) PERSISTENT;
posReturnSum 'Сумма возвратов' (discountCard) = GROUP SUM sum(ReceiptReturnDetail d) IF NOT discountCard[ReceiptDetail](d) BY discountCard(receiptSale(d)) PERSISTENT; 
cumulativeSum 'Накопленная сумма (основная)' (DiscountCard discountCard) = initialSum(discountCard) (+) posSum(discountCard) (-) posReturnSum(discountCard) PERSISTENT;

externalSum 'Дополнительные накопления' (discountCard) = ABSTRACT NUMERIC[16,2] (DiscountCard) PERSISTENT;
signedTransferSum 'Сумма переводов' (discountCard) = ABSTRACT NUMERIC[16,2] (DiscountCard) PERSISTENT;
totalSum 'Накопленная сумма' (DiscountCard d) = cumulativeSum(d) (+) externalSum(d) (+) signedTransferSum(d); 

dateFirstUse 'Дата первого использования'=  GROUP MIN date(Receipt receipt) BY discountCard (receipt);

EXTEND FORM discountCards
    PROPERTIES(d) READONLY AFTER initialSum(d) posSum, posReturnSum, cumulativeSum, externalSum, signedTransferSum, totalSum
    PROPERTIES(d) READONLY AFTER date(d) dateFirstUse
;
