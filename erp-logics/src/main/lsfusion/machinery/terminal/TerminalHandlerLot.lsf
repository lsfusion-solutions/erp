MODULE TerminalHandlerLot;

REQUIRE TerminalHandler, TerminalLot;

NAMESPACE TerminalHandler;

overProcessMarking ABSTRACT LIST (TerminalDocumentDetail, TerminalLotDetail, INTEGER);

process (TerminalDocument document) + {
    DELETE TerminalLotDetail l WHERE terminalDocument(terminalDocumentDetail(l)) == document;

    FOR marking(TerminalDocumentDetail d) AND terminalDocument(d) == document AND count(INTEGER i, jsonArrayLength(marking(d))) AND STRING mark = jsonArrayElement(marking(d), i, 'id') DO NEW l = TerminalLotDetail {
        id(l) <- STRING[200](mark);
        quantity(l) <- NUMERIC[14,3](jsonArrayElement(marking(d), i, 'quantity'));
        terminalDocumentDetail(l) <- d;
        overProcessMarking(d, l, i);
    }
}

in(Sku s, Stock st, TerminalBarcodeFlags f) += WHEN lotType(s) AND st IS Stock AND f == TerminalBarcodeFlags.goodMarking THEN TRUE;

lotInfo = ABSTRACT CASE ISTRING (STRING, INTEGER );
lotInfo(STRING str, INTEGER order) += WHEN order == 100 AND lot(str) THEN 'Марка найдена: ' + idBarcodeSku(lot(str)) + ' ' + nameSku(lot(str));

lotInfo(STRING s) = GROUP CONCAT lotInfo(s, INTEGER o), '' ORDER o;