MODULE Dibal;

REQUIRE ScalesPriceTransaction, Image, Item;

dataCustomGroupType = DATA CustomGroupType(GroupScales);
customGroupType = ABSTRACT CustomGroupType(GroupScales);
customGroupTypeDibal(GroupScales gs) = OVERRIDE dataCustomGroupType(gs), customGroupType(gs);
nameCustomGroupTypeDibal 'Тип классификатора'(GroupScales gs) = name(customGroupTypeDibal(gs));
EXTEND FORM groupScales 
    PROPERTIES (grs) nameCustomGroupTypeDibal SHOWIF sidModel(grs) == 'Dibal';

overId = ABSTRACT STRING[100] (CustomGroup);
idDibal(CustomGroup cg) = OVERRIDE overId(cg), id(cg);

createAttribute(MachineryPriceTransaction mpt) + {
    IF sidModel(groupScales(mpt)) == 'Dibal' THEN {
        LOCAL custGroup = CustomGroup (Barcode);
        custGroup(Barcode b) <- customGroup(customGroupTypeDibal(groupMachinery(mpt)), sku(b)) WHERE in(mpt, b);
        
        info(mpt, Barcode b) <- ('\{"Dibal":\{'+
                (CONCAT ',',
                    (' "numberGroup": "' + (OVERRIDE idDibal(custGroup(b)), '1') +
                    '", nameGroup: "' + (OVERRIDE name(custGroup(b)),'Все') + '"')
                    )
                +'\}\}') WHERE in(mpt, b);
    }
}

//Для загрузки изображений необходимы:
//Windows: DibalImage.dll, Dibalscop.dll, commL.dll и DibalImageFusion.exe
//Linux: not supported
//
//indexImage: 1-99 = группы, 100 и выше = товары (plu + 100)

//dibalImageFusionPath, ip, indexImage, imagePath, logsPath
sendImageToSingleScale 'Send image to single scale'  INTERNAL  'lsfusion.erp.machinery.scales.dibal.DibalSendImageToSingleScaleAction' (STRING, STRING, INTEGER, STRING, STRING);

//dibalImageFusionPath, ip, imageDir, logsPath
sendMultiImagesToSingleScale 'Send multi images to single scale'  INTERNAL  'lsfusion.erp.machinery.scales.dibal.DibalSendMultiImagesToSingleScaleAction' (STRING, STRING, STRING, STRING);


testSingle() {
    sendImageToSingleScale('e:/work/dibal/DibalImageFusion.exe', '192.168.42.144', 170, 'e:/work/dibal/170.bmp', 'e:/work/dibal/dibal.txt');
}

testMulti() {
    sendMultiImagesToSingleScale('e:/work/dibal/DibalImageFusion.exe', '192.168.42.144', 'e:/work/dibal/dir', 'e:/work/dibal/dibal.txt');
}

NAVIGATOR {
    NEW testSingle;
    NEW testMulti;
}