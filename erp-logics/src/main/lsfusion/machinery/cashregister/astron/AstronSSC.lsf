MODULE AstronSSC;

REQUIRE AstronCashRegisterPriceTransaction, ItemSSC;

NAMESPACE Astron;


//товар
imageAstron(Item i) = DATA IMAGEFILE (Item);

WHEN CHANGED (image(Item i)) DO { 
    imageAstron(i) <- NULL;
}
//группа
imageAstron 'Изображение для Astron' = DATA IMAGEFILE (CustomGroup);

EXTEND FORM customGroups
    PROPERTIES (g) READONLY imageAstron;
    
EXTEND FORM customGroup
    PROPERTIES (g) imageAstron;

//группа касс
dataCustomGroupTypeAstron = DATA CustomGroupType(GroupCashRegister);
nameCustomGroupTypeAstron 'Тип классификатора КСО'(GroupCashRegister gs) = name(dataCustomGroupTypeAstron(gs));

testModeAstron '!!!Тестовый режим!!! Для тестовой транзитной' = DATA BOOLEAN (GroupCashRegister);

//выгрузка
encodeBase64 = FORMULA STRING 'regexp_replace(encode(($1),\'base64\'), E\'[\\n\\r]+\', \' \', \'g\' )';
toLoadImages = DATA LOCAL BOOLEAN ();

overAstronInfo1(MachineryPriceTransaction mpt, Barcode b) += 
    (CONCAT ', ',
        //свойства
        '"propertyGrpId":'+value(b) + ',' +
        '"propertyGrp":[\{"propertyGrpId":'+value(b)+',"propertyGrpName":"Свойства для '+value(b)+'"\}],' +
        (CONCAT ', ',
        '"numProperty":[' + (CONCAT ', ',
                '\{"numPropertyKey":14,"propertyGrpId":'+value(b)+',"numberId":'+(100 + age(sku(b)))+'\}' IF ageVerify(sku(b)),
                '\{"numPropertyKey":22,"propertyGrpId":'+value(b)+',"numberId":101\}' IF requireQuantityManual(sku(b)),
                '\{"numPropertyKey":24,"propertyGrpId":'+value(b)+',"numberId":101\}' IF lowWeight(sku(b)),
                '\{"numPropertyKey":25,"propertyGrpId":'+value(b)+',"numberId":101\}' IF weightControlBypass(sku(b))
            ) +']',
        '"numbers":[' + (CONCAT ', ',
                '\{"numberId":101,"numberValue":1,"numberName":"Да"\}' IF requireQuantityManual(sku(b)) OR lowWeight(sku(b)) OR weightControlBypass(sku(b)),
                '\{"numberId":'+(100 + age(sku(b)))+',"numberValue":'+age(sku(b))+',"numberName":"'+age(sku(b))+' лет"\}' IF ageVerify(sku(b))
            ) +']',
        '"binProperty":[' + (CONCAT ', ',
                '\{"binPropertyKey":1,"propertyGrpId":'+value(b)+',"binaryDataId":'+value(b)+'\}' IF imageAstron(sku(b)) AND toLoadImages()
            ) +']',
        '"binaryData":[' + (CONCAT ', ',
                '\{"binaryDataId":'+value(b)+',"binaryDataValue":"'+encodeBase64(imageAstron(sku(b)))+'","binaryDataName":"'+escapeJSONValue(STRING[50](id(b) +' '+nameSku(b)))+'"\}' IF imageAstron(sku(b)) AND toLoadImages()
            ) +']'
        ),
        //группы
        ('"extGrp":['+(GROUP CONCAT ('\{'+ (CONCAT ',','"extGrpId":'+INTEGER(id(CustomGroup g)),
                '"sareaId":'+nppGroupMachinery(mpt),
                '"parentExtGrpId":'+INTEGER(id(parent(g))),
                '"extGrpName":"'+escapeJSONValue(name(g))+'"',
                '"extGrpPicture":"'+encodeBase64(imageAstron(g)) IF toLoadImages()+'"') + '\}') 
                    IF isParent(g, sku(b)) AND customGroupType(g) == dataCustomGroupTypeAstron(groupMachinery(mpt)), ', ' ORDER g) + '],'+
        '"artExtGrp":[\{"extGrpId":'+INTEGER(id(customGroup(dataCustomGroupTypeAstron(groupMachinery(mpt)),sku(b)))) + '\}]') IF customGroup(dataCustomGroupTypeAstron(groupMachinery(mpt)),sku(b))
    ) IF testModeAstron(groupMachinery(mpt))
    ;


beforeCreateAstronPriceTransaction(MachineryPriceTransaction mpt) + {
    IF toLoadImages() THEN {
        
        LOCAL needResize = BOOLEAN(Item);
        needResize(Item i) <- TRUE IF GROUP SUM 1 IF in(mpt, Barcode b) AND i == sku(b) AND NOT imageAstron(i);
    
        IF (GROUP SUM 1 IF needResize(Item i)) THEN NEWSESSION NESTED LOCAL {
            FOR needResize(Item s) DO {
                TRY {
                    resizeImage(image(s),128,128);              
                    convertImage(resizedImage(), 'png');
                    imageAstron(s) <- convertedImage();
                }
            }
            APPLY NESTED LOCAL;
        }
    }
}

loadImages 'Загрузить классификатор с картинками в Кассы'  (GroupCashRegister gtc) {
    NEWSESSION {
        createMachineryPriceTransactionSnapshot() <- TRUE;
        createMachineryPriceTransactionComment() <- 'Загрузка изображений';
        toLoadImages() <- TRUE;
        
        createMachineryPriceTransaction(Sku sku) <- TRUE IF customGroup(dataCustomGroupTypeAstron(gtc),sku) AND hasImage(sku);
        exclude(GroupMachinery group) <- stock(group) == stock(gtc) AND group!=gtc;
        createMachineryPriceTransaction(stock(gtc));
            
        APPLY NESTED LOCAL;
        IF canceled() THEN {
            cancel();
        }
    }
}


EXTEND FORM groupCashRegister 
    PROPERTIES (grc) testModeAstron SHOWIF sidModel(grc) == 'Astron'
    PROPERTIES (grc) SHOWIF (sidModel(grc) == 'Astron' AND testModeAstron(grc)) nameCustomGroupTypeAstron, loadImages;
    
DESIGN groupCashRegister{
    topContainer{
        MOVE PROPERTY (testModeAstron(grc));
        MOVE PROPERTY (nameCustomGroupTypeAstron(grc));
        MOVE PROPERTY (loadImages(grc));
    }
}
