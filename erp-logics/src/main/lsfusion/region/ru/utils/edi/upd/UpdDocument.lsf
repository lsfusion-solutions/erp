MODULE UpdDocument;

REQUIRE MasterData, Utils, Numerator, LegalEntityEDIRu, Contract, Certificate, XMLUtils;

NAMESPACE Upd;

@defineStaticObject(updDocumentStatus, 'Статус УПД');

EXTEND CLASS UpdDocumentStatus {
    SHCF 'СЧФ',
    DOP 'ДОП',
    SHCFDOP 'СЧФДОП'
}

@defineStaticObject(updDocumentPaperStatus, 'Статус УПД (бумажный)');

EXTEND CLASS UpdDocumentPaperStatus {
    first '1',
    second '2'
}

//UpdDocument
CLASS UpdDocument 'УПД';
TABLE updDocument(UpdDocument);

number 'Номер' = DATA STRING[48] (UpdDocument) IN numbered CHARWIDTH 7;

//Титул продавца

//-------СвУчДокОбор---------

idConsignor 'ИД отправителя' = DATA STRING[46] (UpdDocument); //ИдОтпр
idConsignee 'ИД получателя' = DATA STRING[46] (UpdDocument); //ИдПол


//СвОЭДОтпр
nameOperatorConsignor 'Оператор ЭДО' = DATA STRING[1000] (UpdDocument); //ИдОтпр
innOperatorConsignor 'ИНН оператора ЭДО' = DATA STRING[10] (UpdDocument); //ИННЮЛ
codeOperatorConsignor 'ИД оператора ЭДО' = DATA STRING[3] (UpdDocument); //ИдЭДО

//-------Документ---------
status 'Статус' = DATA UpdDocumentStatus (UpdDocument);
nameStatus 'Статус' (UpdDocument upd) = staticCaption(status(upd)) CHARWIDTH 8; //Функция

businessNameDocument 'Наименование документа (по факту хоз.жизни)' = DATA STRING[255] (UpdDocument);//ПоФактХЖ
supplierNameDocument 'Наименование документа' = DATA STRING[255] (UpdDocument); //НаимДокОпр
dateSupplier 'Дата формирования' = DATA DATE (UpdDocument); //ДатаИнфПр - заполнять при формировании XML-файла
timeSupplier 'Время формирования' = DATA TIME (UpdDocument); //ВремИнфПр - заполнять при формировании XML-файла
dateTimeSupplier 'Дата/время формирования' (UpdDocument u) = dateTimeToDateTime(dateSupplier(u), timeSupplier(u)) MATERIALIZED; 
nameOriginatorSupplier 'Составитель' = DATA STRING[1000] (UpdDocument) CHARWIDTH 45; //НаимЭконСубСост

//СвСчФакт
invoiceNumerator 'Нумератор СЧФ' = DATA Numerator (UpdDocument);
nameInvoiceNumerator 'Нумератор СЧФ' (UpdDocument updDocument) = name(invoiceNumerator(updDocument));
 
numberInvoice 'Номер СЧФ' = DATA STRING[1000] (UpdDocument) CHARWIDTH 15; //НомерСчФ
dateInvoice 'Дата СЧФ' = DATA DATE (UpdDocument); //ДатаСчФ
codeCurrency 'Код валюты' = DATA STRING[3] (UpdDocument); //КодОКВ

//-СвПрод
supplier 'Продавец' = DATA LegalEntity(UpdDocument);

okpoSupplier 'ОКПО продавца' = DATA STRING[10] (UpdDocument); //ОКПО

//--ИдСв
//---СвЮЛУч
nameSupplier 'Продавец' = DATA STRING[1000] (UpdDocument) CHARWIDTH 20; //НаимОрг
innSupplier 'ИНН продавца' = DATA STRING[10] (UpdDocument); //ИННЮЛ
kppSupplier 'КПП продавца' = DATA STRING[9] (UpdDocument); //КПП

//---Адрес
//----АдрРФ
regionCodeSupplier 'Код региона продавца' = DATA STRING[3](UpdDocument); //КодРегион

//----АдрИнф
countryCodeAddressSupplier 'Код страны продавца' = DATA STRING[3] (UpdDocument); //КодСтр
adrressSupplier 'Адрес продавца' = DATA STRING[150] (UpdDocument); //АдрТекст

//----КодГАР
codeAdrressSupplier 'Код адреса продавца' = DATA STRING[36] (UpdDocument); //КодГАР

//-БанкРекв
numberAccountSupplier 'Номер банковского счета' = DATA STRING[20](UpdDocument);//НомерСчета

//--СвБанк
nameBankSupplier 'Наименование банка' = DATA STRING[1000](UpdDocument) CHARWIDTH 25;//НаимБанк
MFOBankSupplier 'БИК' = DATA STRING[9](UpdDocument)  CHARWIDTH 9;//БИК
corrAccountBankSupplier 'Корреспондентский счет банка' = DATA STRING[20](UpdDocument);//КорСчет

//-ГрузОт
isConsignerSupplier 'Продавец является отправителем' = DATA BOOLEAN (UpdDocument); //ОнЖе

//-ГрузПолуч
//--ИдСв
//---СвЮЛУч
nameReceiverCompany 'Грузополучатель' = DATA STRING[1000] (UpdDocument) CHARWIDTH 50; //НаимОрг
innReceiverCompany 'ИНН грузополучателя' = DATA STRING[10] (UpdDocument);//ИННЮЛ

//--ГрузПолуч
//---Адрес
//----АдрИнф
countryCodeAddressReceiverCompany 'Код страны грузополучателя' = DATA STRING[3] (UpdDocument); //КодСтр
adrressReceiverCompany 'Адрес грузополучателя' = DATA STRING[150] (UpdDocument);//АдрТекст

//-СвПокуп
customer 'Покупатель' = DATA LegalEntity(UpdDocument);

okpoCustomer 'ОКПО покупателя' = DATA STRING[10] (UpdDocument); //ОКПО

//--ИдСв
//---СвЮЛУч
nameCustomer 'Покупатель' = DATA STRING[1000] (UpdDocument) CHARWIDTH 20; //НаимОрг
innCustomer 'ИНН покупателя' = DATA STRING[10] (UpdDocument); //ИННЮЛ
kppCustomer 'КПП покупателя' = DATA STRING[9] (UpdDocument); //КПП

//---Адрес
//----АдрРФ
regionCodeCustomer 'Код региона покупателя' = DATA STRING[3](UpdDocument); //КодРегион

//----АдрИнф
countryCodeAddressCustomer 'Код страны покупателя' = DATA STRING[3] (UpdDocument); //КодСтр
adrressCustomer 'Адрес покупателя' = DATA STRING[150] (UpdDocument); //АдрТекст

//----КодГАР
codeAdrressCustomer 'Код адреса покупателя' = DATA STRING[36] (UpdDocument); //КодГАР

//-ИнфПолФХЖ1
//--ТекстИнф
codeBusinessEvent 'Идентификатор факта хоз.жизни' = DATA STRING[50] (UpdDocument); //Идентиф
descriptionBusinessEvent 'Описание факта хоз.жизни' = DATA STRING[50] (UpdDocument); //Значен

//СвПродПер
//-СвПер
description 'Содержание операции' = DATA STRING[255] (UpdDocument); //СодОпер

//--ОснПер
descriptionContract 'Основание передачи' = DATA STRING[255] (UpdDocument); //НаимОсн
numberContract 'Номер документа основания' = DATA STRING[255] (UpdDocument);//НомОсн
dateContract 'Дата документа основания' = DATA DATE (UpdDocument);//ДатаОсн

//---СвЛицПер
//----РабОргПрод
positionAgentSupplier 'Должность (работник продавца)' = DATA STRING[128](UpdDocument); //Должность

//-----ФИО
lastNameAgentSupplier 'Фамилия' = DATA STRING[60](UpdDocument); //Фамилия
firsNameAgentSupplier 'Имя' = DATA STRING[60](UpdDocument); //Имя
middleAgentSupplier 'Отчество' = DATA STRING[60](UpdDocument); //Отчество
isAgentSupplier (UpdDocument d) = lastNameAgentSupplier(d) AND firsNameAgentSupplier(d) AND positionAgentSupplier(d);

//----ИнЛицо
//-----ПредОргПер
positionAgentExecuter 'Должность (представитель передающей орг.)' = DATA STRING[128](UpdDocument); //Должность
nameCompanyAgentExecuter 'Наименование организации (представитель передающей орг.)' = DATA STRING[128](UpdDocument); //НаимОргПер

//------ФИО
lastNameAgentExecuter 'Фамилия' = DATA STRING[60](UpdDocument); //Фамилия
firsNametAgentExecuter 'Имя' = DATA STRING[60](UpdDocument); //Имя
middleNameAgentExecuter 'Отчество' = DATA STRING[60](UpdDocument); //Отчество
isAgentExecuter (UpdDocument d) = positionAgentExecuter(d) AND nameCompanyAgentExecuter(d) AND lastNameAgentExecuter(d) AND firsNametAgentExecuter(d);
//-----ФЛПер
positionExecuter 'Должность (передающее ФЛ)' = DATA STRING[128](UpdDocument); //Должность

//------ФИО
lastNameExecuter 'Фамилия (передающее ФЛ)' = DATA STRING[60](UpdDocument); //Фамилия
firsNameExecuter 'Имя (передающее ФЛ)' = DATA STRING[60](UpdDocument); //Имя
middleNameExecuter 'Отчество (передающее ФЛ)' = DATA STRING[60](UpdDocument); //Отчество

//details
CLASS UpdDocumentDetail 'Строка УПД';
TABLE updDocumentDetail(UpdDocumentDetail);

updDocument = DATA UpdDocument(UpdDocumentDetail) NONULL DELETE INDEXED;
defaultIndex '{document.default.index.detail.class}' (UpdDocumentDetail d) =
    PARTITION SUM 1
    ORDER d BY updDocument(d) CHARWIDTH 4;

//ТаблСчФакт
//-СведТов
number 'Номер строки' = DATA NUMERIC[6,0] (UpdDocumentDetail); //НомСтр
nameSku 'Наименование товара' = DATA STRING[1000] (UpdDocumentDetail) CHARWIDTH 45; //НаимТов
//valueVAT 'Ставка НДС' = DATA STRING[35] (UpdDocumentDetail) CHARWIDTH 10; //НалСт

CLASS VATStatus {
    vat0 '0%',
    vat10 '10%',
    vat18 '18%',
    vat20 '20%',
    vat10110 '10/110',
    vat18118 '18/118',
    vat20120 '20/120',
    vatNot 'без НДС',  
    vatAgent 'НДС исчисляется налоговым агентом'         
}
VATStatus = DATA VATStatus(UpdDocumentDetail);
nameVATStatus 'Ставка НДС' = staticCaption(VATStatus(UpdDocumentDetail d)) CHARWIDTH 7;


quantity 'Кол-во товара' = DATA NUMERIC[26,11] (UpdDocumentDetail); //КолТов
price 'Цена' = DATA NUMERIC[26,11] (UpdDocumentDetail); //ЦенаТов
sum 'Сумма без НДС' = DATA NUMERIC[19,2] (UpdDocumentDetail); //СтТовБезНДС
invoiceSum 'Сумма с НДС' = DATA NUMERIC[19,2] (UpdDocumentDetail); //СтТовУчНал

//--Акциз
dutySum 'Сумма акциза' = DATA NUMERIC[19,2](UpdDocumentDetail);//СумАкциз
withoutDuty 'Без акциза' = DATA BOOLEAN (UpdDocumentDetail);//БезАкциз

//--ДопСведТов
idUOM 'ОКЕИ' = DATA STRING[4] (UpdDocumentDetail) CHARWIDTH 10; //ОКЕИ_Тов
nameUOM 'ЕИ' = DATA STRING[255] (UpdDocumentDetail) CHARWIDTH 10; //НаимЕдИзм
nameCountry 'Страна' = DATA STRING[255] (UpdDocumentDetail) CHARWIDTH 10; //КрНаимСтрПр
idSku 'Код товара' = DATA STRING[100] (UpdDocumentDetail) CHARWIDTH 15; //КодТов

//--СвТД
idCountry 'Код страны' = DATA STRING[3] (UpdDocumentDetail) CHARWIDTH 10; //КодПроисх
numberDeclaration 'Номер ТД' = DATA STRING[29] (UpdDocumentDetail) CHARWIDTH 10;//НомерТД

VATSum 'Сумма НДС' = DATA NUMERIC[19,2] (UpdDocumentDetail); //СумНал

//-ВсегоОпл
sum 'Сумма без НДС' = DATA NUMERIC[19,2] (UpdDocument); //СтТовБезНДСВсего
invoiceSum 'Сумма с НДС' = DATA NUMERIC[19,2] (UpdDocument); //СтТовУчНалВсего

//--СумНалВсего 
VATSum 'Сумма НДС' = DATA NUMERIC[19,2] (UpdDocument); //СумНал
withoutVAT 'БезНДС' = DATA BOOLEAN (UpdDocument); //БезНДС

//Подписант
CLASS  Credential 'Область полномочий подписанта (продавец)' {
    c0 '0',
    c1 '1',
    c2 '2', 
    c3 '3',
    c4 '4',
    c5 '5', 
    c6 '6'    
}
supplierSignerCredentials = DATA Credential(UpdDocument);
nameSupplierSignerCredentials 'Область полномочий подписанта (продавец)' = staticCaption(supplierSignerCredentials(UpdDocument d)); //ОблПолн

CLASS  CStatus 'Статус подписанта (продавец)' {
    c1 '1',
    c2 '2', 
    c3 '3',
    c4 '4'  
}
supplierSignerStatus = DATA CStatus(UpdDocument);
nameSupplierSignerStatus 'Статус подписанта (продавец)' = staticCaption(supplierSignerStatus(UpdDocument d)); //Статус
supplierSignerCredentialsBase 'Основание полномочий подписанта (продавец)' = DATA STRING[255] (UpdDocument) CHARWIDTH 50; //ОснПолн

//-ФЛ
//--ФИО
supplierSignerLastName 'Фамилия подписанта (продавец)' = DATA STRING[60] (UpdDocument);//Фамилия
supplierSignerFirstName 'Имя подписанта (продавец)' = DATA STRING[60] (UpdDocument);//Имя
supplierSignerMiddleName 'Отчество (продавец)' = DATA STRING[60](UpdDocument); //Отчество
isSupplierSigner (UpdDocument d) = supplierSignerLastName(d) AND supplierSignerFirstName(d);

//-ЮЛ
supplierSignerInn 'ИНН организации-подписанта (продавец)' = DATA STRING[10] (UpdDocument);//ИННЮЛ
supplierSignerPosition 'Должность подписанта (продавец)' = DATA STRING[128] (UpdDocument);//Должн

//--ФИО
supplierSignerAgentLastName 'Фамилия' = DATA STRING[60] (UpdDocument);//Фамилия
supplierSignerAgentFirstName 'Имя' = DATA STRING[60] (UpdDocument);//Имя
supplierSignerAgentMiddleName 'Отчество' = DATA STRING[60](UpdDocument); //Отчество

//Титул покупателя
//-------ИнфПок---------
dateCustomer 'Дата формирования (покупатель)' = DATA DATE (UpdDocument); //ДатаИнфПок
timeCustomer 'Время формирования (покупатель)' = DATA TIME (UpdDocument); //ВремИнфПок
nameOriginatorCustomer 'Наименование составителя (покупатель)' = DATA STRING[1000] (UpdDocument) CHARWIDTH 45; //НаимЭконСубСост

//СодФХЖ4
//-СвПрин
dateExceptance 'Дата принятия' = DATA DATE (UpdDocument); //ДатаПрин

//--СвЛицПрин
//---РабОргПок
positionAgentCustomer 'Должность (работник покупателя)' = DATA STRING[128](UpdDocument); //Должность
customerAgentCredentialsBase 'Основание полномочий (работник покупателя)' = DATA STRING[255] (UpdDocument) CHARWIDTH 50; //ОснПолн

//----ФИО
lastNameAgentCustomer 'Фамилия (работник покупателя)' = DATA STRING[60](UpdDocument); //Фамилия
firsNameAgentCustomer 'Имя (работник покупателя)' = DATA STRING[60](UpdDocument); //Имя
middleAgentCustomer 'Отчество (работник покупателя)' = DATA STRING[60](UpdDocument); //Отчество

//---ИнЛицо
//----ПредОргПрин
positionAgentReceiver 'Должность (представитель принимающей орг.)' = DATA STRING[128](UpdDocument); //Должность

//-----ФИО
lastNameAgentReceiver 'Фамилия' = DATA STRING[60](UpdDocument); //Фамилия
firsNametAgentReceiver 'Имя' = DATA STRING[60](UpdDocument); //Имя
middleNameAgentReceiver 'Отчество' = DATA STRING[60](UpdDocument); //Отчество

//----ФЛПрин
receiverAgentCredentialsBase 'Основание полномочий (принимающее ФЛ)' = DATA STRING[120](UpdDocument); //ОснДоверФЛ

//------ФИО
lastNameReceiver 'Фамилия (принимающее ФЛ)' = DATA STRING[60](UpdDocument); //Фамилия
firsNameReceiver 'Имя (принимающее ФЛ)' = DATA STRING[60](UpdDocument); //Имя
middleNameReceiver 'Отчество (принимающее ФЛ)' = DATA STRING[60](UpdDocument); //Отчество


//Подписант
customerSignerCredentials 'Область полномочий подписанта' = DATA INTEGER (UpdDocument); //ОблПолн
customerSignerStatus 'Статус подписанта' = DATA INTEGER (UpdDocument); //Статус
customerSignerCredentialsBase 'Основание полномочий подписанта' = DATA STRING[255] (UpdDocument) CHARWIDTH 50; //ОснПолн

//-ФЛ
//--ФИО
customerSignerLastName 'Фамилия подписанта' = DATA STRING[60] (UpdDocument);//Фамилия
customerSignerFirstName 'Имя подписанта' = DATA STRING[60] (UpdDocument);//Имя
customerSignerMiddleName 'Отчество' = DATA STRING[60](UpdDocument); //Отчество

//-ЮЛ
customerSignerInn 'ИНН организации-подписанта' = DATA STRING[10] (UpdDocument);//ИННЮЛ
customerSignerPosition 'Должность представителя подписанта' = DATA STRING[128] (UpdDocument);//Должн

//--ФИО
customerSignerAgentLastName 'Фамилия представителя подписанта' = DATA STRING[60] (UpdDocument);//Фамилия
customerSignerAgentFirstName 'Имя представителя подписанта' = DATA STRING[60] (UpdDocument);//Имя
customerSignerAgentMiddleName 'Отчество представителя' = DATA STRING[60](UpdDocument); //Отчество

//sending
transfered 'Дата/время отправки' = DATA DATETIME (UpdDocument);
isTransfered 'Отправлен' (UpdDocument u) = u IS UpdDocument AND transfered(u);

uuid 'UUID' = DATA ISTRING[36] (UpdDocument);
idFile 'ИдФайл' (UpdDocument d) = STRING[255](CONCAT '_', 'ON_NSCHFDOPPR',  idConsignee(d), [FORMULA STRING[8] 'to_char(($1),\'YYYYMMDD\')'](dateSupplier(d)), idConsignor(d), uuid(d)) CHARWIDTH 25;

generateIdFile (UpdDocument d) {
    IF NOT uuid(d) THEN NEWSESSION {
        generateUUID();
        uuid(d) <- ISTRING[36](generatedUUID());
        APPLY;    
    }
}

FORM updDocument 'Универсальный передаточный документ'
    OBJECTS u=UpdDocument PANEL

    PROPERTIES (u) idFile READONLY, idConsignor, idConsignee, nameStatus, businessNameDocument, supplierNameDocument
    PROPERTIES (u) nameOperatorConsignor, innOperatorConsignor, codeOperatorConsignor
                
    PROPERTIES (u) nameSupplier, innSupplier, kppSupplier, okpoSupplier, nameOriginatorSupplier
    PROPERTIES (u) dateSupplier, timeSupplier
    PROPERTIES (u) nameInvoiceNumerator, numberInvoice, dateInvoice, codeCurrency
    PROPERTIES (u) regionCodeSupplier, countryCodeAddressSupplier, adrressSupplier, codeAdrressSupplier
    PROPERTIES (u) numberAccountSupplier, nameBankSupplier, MFOBankSupplier, corrAccountBankSupplier
    
    PROPERTIES (u) isConsignerSupplier
    PROPERTIES (u) nameCustomer, innCustomer, kppCustomer, okpoCustomer
    PROPERTIES (u) regionCodeCustomer, countryCodeAddressCustomer, codeAdrressCustomer
    PROPERTIES (u) nameReceiverCompany, innReceiverCompany
    PROPERTIES (u) countryCodeAddressReceiverCompany, adrressReceiverCompany
    PROPERTIES (u) codeBusinessEvent, descriptionBusinessEvent
    PROPERTIES (u) description, descriptionContract, numberContract, dateContract
    PROPERTIES (u) positionAgentSupplier, lastNameAgentSupplier, firsNameAgentSupplier, middleAgentSupplier
    PROPERTIES (u) positionAgentExecuter, nameCompanyAgentExecuter, lastNameAgentExecuter, firsNametAgentExecuter, middleNameAgentExecuter
    PROPERTIES (u) positionExecuter, lastNameExecuter, firsNameExecuter, middleNameExecuter
    PROPERTIES (u) sum, invoiceSum, VATSum, withoutVAT
    PROPERTIES (u) nameSupplierSignerCredentials, nameSupplierSignerStatus, supplierSignerCredentialsBase
    PROPERTIES (u) supplierSignerLastName, supplierSignerFirstName, supplierSignerMiddleName
    PROPERTIES (u) supplierSignerInn, supplierSignerPosition
    PROPERTIES (u) supplierSignerAgentLastName, supplierSignerAgentFirstName, supplierSignerAgentMiddleName
    
    PROPERTIES (u) dateCustomer, timeCustomer, nameOriginatorCustomer
    PROPERTIES (u) dateExceptance
    PROPERTIES (u) positionAgentCustomer, customerAgentCredentialsBase, lastNameAgentCustomer, firsNameAgentCustomer, middleAgentCustomer
    PROPERTIES (u) positionAgentReceiver, lastNameAgentReceiver, firsNametAgentReceiver, middleNameAgentReceiver
    PROPERTIES (u) receiverAgentCredentialsBase, lastNameReceiver, firsNameReceiver, middleNameReceiver
    PROPERTIES (u) customerSignerCredentials, customerSignerStatus, customerSignerCredentialsBase
    PROPERTIES (u) customerSignerLastName, customerSignerFirstName, customerSignerMiddleName
    PROPERTIES (u) customerSignerInn, customerSignerPosition, customerSignerAgentLastName, customerSignerAgentFirstName, customerSignerAgentMiddleName
    
    PROPERTIES (u) transfered READONLY
    
    OBJECTS d=UpdDocumentDetail
    
    PROPERTIES(d) number, idSku, nameSku, quantity, price, sum,  nameVATStatus, invoiceSum, VATSum, dutySum, withoutDuty
    PROPERTIES(d) idUOM, nameUOM, idCountry, nameCountry, numberDeclaration 
                  
    PROPERTIES (d) NEW, DELETE
        
    FILTERS updDocument(d) == u,
            quantity(d)
    
    EDIT UpdDocument OBJECT u           
;

DESIGN updDocument {
    BOX {
        size = (1024, 768);
        NEW mainContainer {
            type = SCROLL;
            fill = 1;
            NEW documentContainer {
                fill = 1;
                type = CONTAINERV;
                NEW mainDocumentAttributes {
                    alignment = STRETCH;
                    type = CONTAINERH;
                    
                    NEW supplierInvoice {
                        caption = 'СЧФ';
                        fill = 1;
                        type = CONTAINERV;
                        MOVE PROPERTY(nameInvoiceNumerator(u));
                        MOVE PROPERTY(numberInvoice(u));
                        MOVE PROPERTY(dateInvoice(u));
                        MOVE PROPERTY(nameStatus(u));                       
                    }
                    NEW partsInfo0{
                        fill = 1;
                        NEW partsInfo {
                            caption = 'Стороны';
                            fill = 1;
                            type = CONTAINERV;
                            MOVE PROPERTY(nameSupplier(u));
                            MOVE PROPERTY(nameCustomer(u));                       
                        }
                    }
                    NEW sums {
                        caption = 'Итоговые суммы';
                        fill = 1;
                        type = CONTAINERV;
                        MOVE PROPERTY(codeCurrency(u));
                        MOVE PROPERTY(sum(u));
                        MOVE PROPERTY(invoiceSum(u));
                        MOVE PROPERTY(VATSum(u));
                        MOVE PROPERTY(withoutVAT(u));                            
                    }
                }
                NEW titlesContainer {
                    fill = 1;
                    type = TABBED;
                    NEW supplierTitle {
                        caption = 'Титул поставщика';
                        fill = 1;
                        type = SPLITV;
                        
                        NEW supplierInfo {
                            caption = 'Поставщик';
                            fill = 1;
                            type = TABBED;
                            
                            NEW supplierMainInfo {
                                caption = 'Реквизиты поставщика';
                                fill = 1;
                                type = CONTAINERH;
                                NEW innSupplier {
                                    caption = 'Основные';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(innSupplier(u));
                                    MOVE PROPERTY(kppSupplier(u));
                                    MOVE PROPERTY(okpoSupplier(u));
                                    MOVE PROPERTY(nameOriginatorSupplier(u));
                                }
                                NEW supplierAddress {
                                    caption = 'Адрес';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(regionCodeSupplier(u));
                                    MOVE PROPERTY(countryCodeAddressSupplier(u));
                                    MOVE PROPERTY(adrressSupplier(u));
                                    MOVE PROPERTY(codeAdrressSupplier(u));
                                }
                                NEW supplierBank {
                                    caption = 'Банк';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(numberAccountSupplier(u));
                                    MOVE PROPERTY(nameBankSupplier(u));
                                    MOVE PROPERTY(MFOBankSupplier(u));
                                    MOVE PROPERTY(corrAccountBankSupplier(u));
                                }
                            }
                            NEW documentInfo {
                                caption = 'Реквизиты документа';
                                fill = 1;
                                type = TABBED; 
                                NEW documentDescription {
                                    caption = 'Описание';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(description(u));
                                    MOVE PROPERTY(codeBusinessEvent(u));
                                    MOVE PROPERTY(descriptionBusinessEvent(u));
                                }
                                NEW supplierDateTime {
                                    caption = 'Время формирования';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(dateSupplier(u));
                                    MOVE PROPERTY(timeSupplier(u));
                                }
                                NEW contractInfo {
                                    caption = 'Основание';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(descriptionContract(u));
                                    MOVE PROPERTY(numberContract(u));
                                    MOVE PROPERTY(dateContract(u)); 
                                }                                                        
                            }
                            
                            NEW itemTransfer {
                                caption = 'Передача';
                                fill = 1;
                                type = CONTAINERV;
                                MOVE PROPERTY(isConsignerSupplier(u));
                                NEW itemTransferTabbedContainer {
                                     fill = 1;
                                     type = TABBED;
                                     NEW supplierAgent {
                                         caption = 'Работник продавца';
                                         fill = 1;
                                         type = CONTAINERV;
                                         MOVE PROPERTY(positionAgentSupplier(u));
                                         MOVE PROPERTY(lastNameAgentSupplier(u));
                                         MOVE PROPERTY(firsNameAgentSupplier(u));
                                         MOVE PROPERTY(middleAgentSupplier(u));                            
                                     }
                                     NEW executerAgent {
                                         caption = 'Представитель передающей организации';
                                         fill = 1;
                                         type = CONTAINERV;
                                         MOVE PROPERTY(positionAgentExecuter(u));
                                         MOVE PROPERTY(nameCompanyAgentExecuter(u));
                                         MOVE PROPERTY(lastNameAgentExecuter(u));
                                         MOVE PROPERTY(firsNametAgentExecuter(u));
                                         MOVE PROPERTY(middleNameAgentExecuter(u));                            
                                     }
                                     NEW executer {
                                         caption = 'Передающее физлицо';
                                         fill = 1;
                                         type = CONTAINERV;
                                         MOVE PROPERTY(positionExecuter(u));
                                         MOVE PROPERTY(lastNameExecuter(u));
                                         MOVE PROPERTY(firsNameExecuter(u));
                                         MOVE PROPERTY(middleNameExecuter(u));                            
                                     }
                                }
                            }
                            NEW signerInfo {
                                caption = 'Подписи';
                                fill = 1;
                                type = TABBED;
                                NEW signerCredentials {
                                    caption = 'Полномочия подписанта';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(nameSupplierSignerCredentials(u));
                                    MOVE PROPERTY(nameSupplierSignerStatus(u));
                                    MOVE PROPERTY(supplierSignerCredentialsBase(u));                                                        
                                }
                                NEW signer {
                                    caption = 'Подписант (физлицо)';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(supplierSignerLastName(u));
                                    MOVE PROPERTY(supplierSignerFirstName(u));
                                    MOVE PROPERTY(supplierSignerMiddleName(u));                            
                                }
                                NEW signerLegalEntity {
                                    caption = 'Подписант (юрлицо)';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(supplierSignerInn(u));
                                    MOVE PROPERTY(supplierSignerPosition(u));
                                    NEW signerLegalEntityAgent {
                                        caption = 'Представитель';
                                        MOVE PROPERTY(supplierSignerAgentLastName(u));
                                        MOVE PROPERTY(supplierSignerAgentFirstName(u));
                                        MOVE PROPERTY(supplierSignerAgentMiddleName(u));                                
                                    }                            
                                }
                            }                            
                        }
                        
                        NEW customerInfo {
                            caption = 'Покупатель';
                            fill = 1;
                            type = TABBED;
                            NEW customerMainInfo {
                                caption = 'Реквизиты покупателя';
                                fill = 1;
                                type = CONTAINERH;
                                NEW innCustomer {
                                    fill = 1;
                                    caption = 'Основные';
                                    type = CONTAINERV;
                                    MOVE PROPERTY(innCustomer(u));
                                    MOVE PROPERTY(kppCustomer(u));
                                    MOVE PROPERTY(okpoCustomer(u));
                                }    
                                NEW customerAddress {
                                    caption = 'Адрес';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(regionCodeCustomer(u));
                                    MOVE PROPERTY(countryCodeAddressCustomer(u));
                                    MOVE PROPERTY(codeAdrressCustomer(u));
                                }
                            }    
                            NEW companyReceiver {
                                caption = 'Грузополучатель';
                                fill = 1;
                                type = CONTAINERH;
                                NEW companyReceiverInfo {
                                    fill = 1;
                                    caption = 'Реквизиты';
                                    type = CONTAINERV;
                                    MOVE PROPERTY(nameReceiverCompany(u));
                                    MOVE PROPERTY(innReceiverCompany(u));
                                }
                                NEW companyReceiverAddress {
                                    caption = 'Адрес грузополучателя';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(countryCodeAddressReceiverCompany(u));
                                    MOVE PROPERTY(adrressReceiverCompany(u));                            
                                }
                            }
                        }                                                                     
                    }
                    NEW customerTitle {
                        caption = 'Титул покупателя';
                        fill = 1;
                        type = TABBED;
                        
                        NEW customerInfoCT {
                            caption = 'Покупатель';
                            fill = 1;
                            type = CONTAINERV;
                            MOVE PROPERTY(nameOriginatorCustomer(u));  
                            MOVE PROPERTY(dateCustomer(u));
                            MOVE PROPERTY(timeCustomer(u));                          
                        }
                        NEW acceptanceInfo {
                            caption = 'Приемка';
                            fill = 1;
                            type = CONTAINERV;
                            MOVE PROPERTY(dateExceptance(u));
                            NEW acceptanceInfoVerticalContainer {
                                alignment = STRETCH;
                                type = CONTAINERH;
                                NEW receiverAgent {
                                    caption = 'Представитель принимающей организации';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(positionAgentReceiver(u));
                                    MOVE PROPERTY(lastNameAgentReceiver(u));
                                    MOVE PROPERTY(firsNametAgentReceiver(u));
                                    MOVE PROPERTY(middleNameAgentReceiver(u));                            
                                }                       
                                NEW receiver {
                                    caption = 'Принимающее физлицо';
                                    fill = 1;
                                    type = CONTAINERV;
                                    MOVE PROPERTY(receiverAgentCredentialsBase(u));
                                    MOVE PROPERTY(lastNameReceiver(u));
                                    MOVE PROPERTY(firsNameReceiver(u));
                                    MOVE PROPERTY(middleNameReceiver(u));                            
                                } 
                            }                           
                        }
                        NEW customerSignerContainer {
                            caption = 'Подписи';
                            fill = 1;
                            type = COLUMNS;
                            columns = 2;
                            NEW customerAgent {
                                caption = 'Работник покупателя';
                                fill = 1;
                                type = CONTAINERV;
                                MOVE PROPERTY(positionAgentCustomer(u));
                                MOVE PROPERTY(customerAgentCredentialsBase(u));
                                MOVE PROPERTY(lastNameAgentCustomer(u));
                                MOVE PROPERTY(firsNameAgentCustomer(u));
                                MOVE PROPERTY(middleAgentCustomer(u));                            
                            }
    
                            NEW customerSignerCredentials {
                                caption = 'Полномочия подписанта';
                                fill = 1;
                                type = CONTAINERV;                            
                                MOVE PROPERTY(customerSignerCredentials(u));
                                MOVE PROPERTY(customerSignerStatus(u));
                                MOVE PROPERTY(customerSignerCredentialsBase(u));                           
                            }
                            NEW customerSigner {
                                caption = 'Подписант (физлицо)';
                                fill = 1;
                                type = CONTAINERV;
                                MOVE PROPERTY(customerSignerLastName(u));
                                MOVE PROPERTY(customerSignerFirstName(u));
                                MOVE PROPERTY(customerSignerMiddleName(u));                    
                            }
                            NEW signerCustomerLegalEntity {
                                caption = 'Подписант (юрлицо)';
                                fill = 1;
                                type = CONTAINERV;
                                MOVE PROPERTY(customerSignerInn(u));
                                MOVE PROPERTY(customerSignerPosition(u));
                                NEW signerCustomerLegalEntityAgent {
                                    caption = 'Представитель';
                                    MOVE PROPERTY(customerSignerAgentLastName(u));
                                    MOVE PROPERTY(customerSignerAgentFirstName(u));
                                    MOVE PROPERTY(customerSignerAgentMiddleName(u));                          
                                }                            
                            }
                        }
                        
                    }
                    NEW idsContainer {
                        caption = 'ИД';
                        fill = 1;
                        type = CONTAINERV;
                        MOVE PROPERTY(idFile(u));
                        MOVE PROPERTY(idConsignor(u));
                        MOVE PROPERTY(idConsignee(u));
                        MOVE PROPERTY(businessNameDocument(u));
                        MOVE PROPERTY(supplierNameDocument(u));                        
                    }
                    NEW detailsContainer {
                        caption = 'Строки УПД';
                        fill = 1;
                        type = CONTAINERV;
                        MOVE BOX(d) {
                            fill = 1;
                        }
                    }                   
                    NEW edo {
                        caption = 'Оператор ЭДО';
                        type = CONTAINERV;
                        MOVE PROPERTY(nameOperatorConsignor(u));
                        MOVE PROPERTY(innOperatorConsignor(u));
                        MOVE PROPERTY(codeOperatorConsignor(u));                               
                    }
                    NEW transfer {
                        caption = 'Отправка';
                        MOVE PROPERTY (transfered(u));
                    }
                }
            }
        }
        MOVE TOOLBARBOX;
    } 
}

filterDateFrom 'Дата с' = DATA LOCAL DATE ();
filterDateFrom (UpdDocument u) = dateInvoice(u) >= filterDateFrom() OR (u IS UpdDocument AND NOT filterDateFrom());      

filterDateTo 'Дата по' = DATA LOCAL DATE ();
filterDateTo (UpdDocument u) = dateInvoice(u) <= filterDateTo() OR (u IS UpdDocument AND NOT filterDateTo());      

filterSupplier  = DATA LOCAL LegalEntity ();
nameFilterSupplier 'Продавец' = name(filterSupplier()) CHARWIDTH 15;          
filterSupplier (UpdDocument u) = supplier(u) == filterSupplier() OR (u IS UpdDocument AND NOT filterSupplier());

filterCustomer  = DATA LOCAL LegalEntity ();
nameFilterCustomer 'Покупатель' = name(filterCustomer()) CHARWIDTH 15;          
filterCustomer (UpdDocument u) = customer(u) == filterCustomer() OR (u IS UpdDocument AND NOT filterCustomer());

select 'Отм.' = DATA LOCAL NESTED BOOLEAN (UpdDocument);
countSelectUpd = GROUP SUM 1 IF select(UpdDocument u);

FORM updDocuments 'УПД'

    PROPERTIES filterDateFrom(), filterDateTo(), nameFilterSupplier(), nameFilterCustomer()
    
    OBJECTS u = UpdDocument
    PROPERTIES (u) select
    PROPERTIES (u) READONLY nameStatus, isTransfered, transfered, numberInvoice, dateInvoice, 
                            nameSupplier, nameCustomer,
                            dateTimeSupplier, codeCurrency,
                            sum, invoiceSum, VATSum, withoutVAT, idFile, idConsignor, idConsignee
                            
    FILTERGROUP transfered
        FILTER 'Отправленные' transfered(u)
        FILTER 'Неотправленные' NOT transfered(u)

    FILTERS filterDateFrom(u), filterDateTo(u), filterSupplier(u), filterCustomer(u)
    
    OBJECTS d = UpdDocumentDetail
    
    PROPERTIES(d) READONLY number, idSku, nameSku, quantity, price, sum, nameVATStatus, invoiceSum, VATSum, dutySum, withoutDuty
                  
    PROPERTIES(u) NEWSESSION NEW, EDIT, DELETE            
        
    FILTERS updDocument(d) == u,
            quantity(d)
;

NAVIGATOR {
    customsNavigator {
        NEW FOLDER UPD 'УПД' {
            NEW updDocuments;
        }
    }
}

inReport = DATA LOCAL BOOLEAN (UpdDocument);
minUpdDocument = GROUP MIN UpdDocument d IF inReport(d);

GROUP UPDExportA0 EXTID  'СвОЭДОтпр';

GROUP UPDExportA EXTID  'СвСчФакт';
    GROUP UPDExportA2 EXTID  'СвПрод' :UPDExportA;   
        GROUP UPDExportA2_1 EXTID  'ИдСв' :UPDExportA2;        
            GROUP UPDExportA2_1_1 EXTID  'СвЮЛУч' :UPDExportA2_1;            
        GROUP UPDExportA2_2 EXTID  'Адрес' :UPDExportA2;
            GROUP UPDExportA2_2_1 EXTID  'АдрРФ' :UPDExportA2_2;
            GROUP UPDExportA2_2_2 EXTID  'АдрИнф' :UPDExportA2_2;
        GROUP UPDExportA2_4 EXTID  'БанкРекв' :UPDExportA2;            
            GROUP UPDExportA2_4_1 EXTID  'СвБанк' :UPDExportA2_4;     
    GROUP UPDExportA3 EXTID  'ГрузОт' :UPDExportA;
    GROUP UPDExportA4 EXTID  'ГрузПолуч' :UPDExportA;
        GROUP UPDExportA4_1 EXTID  'ИдСв' :UPDExportA4;
            GROUP UPDExportA4_1_1 EXTID  'СвЮЛУч' :UPDExportA4_1;
        GROUP UPDExportA4_2 EXTID  'Адрес' :UPDExportA4;
            GROUP UPDExportA4_2_1 EXTID  'АдрРФ' :UPDExportA4_2;
            GROUP UPDExportA4_2_2 EXTID  'АдрИнф' :UPDExportA4_2;
    GROUP UPDExportA6 EXTID  'СвПокуп' :UPDExportA;
        GROUP UPDExportA6_1 EXTID  'ИдСв' :UPDExportA6;
            GROUP UPDExportA6_1_1 EXTID  'СвЮЛУч' :UPDExportA6_1;
        GROUP UPDExportA6_2 EXTID  'Адрес' :UPDExportA6;
            GROUP UPDExportA6_2_1 EXTID  'АдрРФ' :UPDExportA6_2;
            GROUP UPDExportA6_2_2 EXTID  'АдрИнф' :UPDExportA6_2;
    GROUP UPDExportA9 EXTID  'ИнфПолФХЖ1' :UPDExportA;
        GROUP UPDExportA9_1 EXTID  'ТекстИнф' :UPDExportA9;
        
GROUP UPDExportB EXTID  'ТаблСчФакт';      
    GROUP UPDExportB1 EXTID  'Акциз';      
    GROUP UPDExportB2 EXTID  'СумНал';     
    GROUP UPDExportB3 EXTID  'СвТД';    
    GROUP UPDExportB4 EXTID  'ДопСведТов';     
GROUP UPDExportBB EXTID  'ВсегоОпл' : UPDExportB;              
GROUP UPDExportBB_1 EXTID  'СумНалВсего' : UPDExportBB;            
            
GROUP UPDExportC EXTID  'СвПродПер';
    GROUP UPDExportC1 EXTID  'СвПер': UPDExportC;
        GROUP UPDExportC1_1 EXTID  'ОснПер': UPDExportC1;   
        GROUP UPDExportC1_2 EXTID  'СвЛицПер': UPDExportC1;           
            GROUP UPDExportC1_2_1 EXTID  'РабОргПрод': UPDExportC1_2;  
                GROUP UPDExportC1_2_1_1 EXTID  'ФИО': UPDExportC1_2_1;                        
            GROUP UPDExportC1_2_2 EXTID  'ИнЛицо': UPDExportC1_2; 
                GROUP UPDExportC1_2_2_1 EXTID  'ПредОргПер': UPDExportC1_2_2;  
                    GROUP UPDExportC1_2_2_1_1 EXTID  'ФИО': UPDExportC1_2_2_1;             
                GROUP UPDExportC1_2_2_2 EXTID  'ФЛПер': UPDExportC1_2_2;     
                    GROUP UPDExportC1_2_2_2_1 EXTID  'ФИО': UPDExportC1_2_2_2;                      
                
GROUP UPDExportD EXTID  'Подписант';
    GROUP UPDExportD_1 EXTID  'ФЛ':UPDExportD;   
        GROUP UPDExportD_1_1 EXTID  'ФИО':UPDExportD_1;             
    GROUP UPDExportD_2 EXTID  'ИП':UPDExportD; 
        GROUP UPDExportD_2_1 EXTID  'ФИО':UPDExportD_2;  
    GROUP UPDExportD_3 EXTID  'ЮЛ':UPDExportD;          
        GROUP UPDExportD_3_1 EXTID  'ФИО':UPDExportD_3;  
                     
FORM UPDPR FORMEXTID '=:Файл'
    PROPERTIES ATTR ='http://www.w3.org/2001/XMLSchema' EXTID 'xmlns:xsd', ='http://www.w3.org/2001/XMLSchema-instance' EXTID 'xmlns:xsi'
    PROPERTIES   = (OVERRIDE idFile(minUpdDocument()), '') EXTID 'ИдФайл' ATTR, 
                 = '3.19.710' EXTID 'ВерсПрог' ATTR, 
                 = '5.01'  EXTID 'ВерсФорм' ATTR
    OBJECTS g = UpdDocument EXTID 'СвУчДокОбор'
    FILTERS inReport(g)

    PROPERTIES = (OVERRIDE idConsignor(g),'') EXTID 'ИдОтпр' ATTR ,
               = (OVERRIDE idConsignee(g),'') EXTID 'ИдПол' ATTR                 
               
    PROPERTIES = nameOperatorConsignor(g) EXTID 'НаимОрг' ATTR IN UPDExportA0,
               = innOperatorConsignor(g) EXTID 'ИННЮЛ' ATTR IN UPDExportA0,
               = codeOperatorConsignor(g) EXTID 'ИдЭДО' ATTR IN UPDExportA0                 
               
    OBJECTS d = UpdDocument EXTID 'Документ'
    FILTERS inReport(d)    
    PROPERTIES = '1115131' IF d IS UpdDocument EXTID 'КНД' ATTR,
               = (OVERRIDE nameStatus(d),'') EXTID 'Функция' ATTR,
               = businessNameDocument(d) EXTID 'ПоФактХЖ' ATTR,
               = supplierNameDocument(d) EXTID 'НаимДокОпр' ATTR,
               = toDateDDMMYYYY(OVERRIDE dateSupplier(d), currentDate()) EXTID 'ДатаИнфПр' ATTR,                     
               = [FORMULA STRING[20] 'to_char(($1),\'HH24.MI.SS\')'](OVERRIDE timeSupplier(d), currentTime()) EXTID 'ВремИнфПр' ATTR,
               = (OVERRIDE nameOriginatorSupplier(d),'')  EXTID 'НаимЭконСубСост' ATTR
               
    PROPERTIES = (OVERRIDE numberInvoice(d),' ') EXTID 'НомерСчФ' ATTR IN UPDExportA,
               = toDateDDMMYYYY(OVERRIDE dateInvoice(d), currentDate()) EXTID 'ДатаСчФ' ATTR IN UPDExportA,
               = (OVERRIDE codeCurrency(d),'') EXTID 'КодОКВ' ATTR IN UPDExportA
               
    PROPERTIES = okpoSupplier(d) EXTID 'ОКПО' ATTR IN UPDExportA2    
    
    PROPERTIES = (OVERRIDE nameSupplier(d),' ') EXTID 'НаимОрг' ATTR IN UPDExportA2_1_1,
               = innSupplier(d) EXTID 'ИННЮЛ' ATTR IN UPDExportA2_1_1,
               = kppSupplier(d) EXTID 'КПП' ATTR IN UPDExportA2_1_1    
               
    PROPERTIES = (regionCodeSupplier(d) IF regionCodeSupplier(d) AND NOT codeAdrressSupplier(d)) EXTID 'КодРегион' ATTR IN UPDExportA2_2_1            
    PROPERTIES = (countryCodeAddressSupplier(d) IF NOT (codeAdrressSupplier(d) OR regionCodeSupplier(d))) EXTID 'КодСтр' ATTR IN UPDExportA2_2_2,
               = (adrressSupplier(d) IF NOT (codeAdrressSupplier(d) OR regionCodeSupplier(d))) EXTID 'АдрТекст' ATTR IN UPDExportA2_2_2    
    PROPERTIES = codeAdrressSupplier(d) EXTID 'КодГАР' IN UPDExportA2_2  
        
    PROPERTIES = numberAccountSupplier(d) EXTID 'НомерСчета' ATTR IN UPDExportA2_4            
    PROPERTIES = nameBankSupplier(d) EXTID 'НаимБанк' ATTR IN UPDExportA2_4_1,   
               = MFOBankSupplier(d) EXTID 'БИК' ATTR IN UPDExportA2_4_1,
               = corrAccountBankSupplier(d) EXTID 'КорСчет' ATTR IN UPDExportA2_4_1                              
    
    PROPERTIES = 'он же' IF isConsignerSupplier(d) EXTID 'ОнЖе' IN UPDExportA3      

    PROPERTIES = (OVERRIDE nameReceiverCompany(d),'') EXTID 'НаимОрг' ATTR IN UPDExportA4_1_1,
               = innReceiverCompany(d)EXTID 'ИННЮЛ' ATTR IN UPDExportA4_1_1
               
//    PROPERTIES = (regionCodeCustomer(d) IF regionCodeCustomer(d) AND NOT codeAdrressReceiverCompany(d)) EXTID 'КодРегион' ATTR IN UPDExportA4_2_1 
    PROPERTIES = countryCodeAddressReceiverCompany(d) EXTID 'КодСтр' ATTR IN UPDExportA4_2_2,
               = adrressReceiverCompany(d)  EXTID 'АдрТекст' ATTR IN UPDExportA4_2_2    
//    PROPERTIES = codeAdrressReceiverCompany(d) EXTID 'КодГАР' IN UPDExportA4_2    
                   
    PROPERTIES = okpoCustomer(d) EXTID 'ОКПО' ATTR IN UPDExportA6   
    
    PROPERTIES = (OVERRIDE nameCustomer(d),'') EXTID 'НаимОрг' ATTR IN UPDExportA6_1_1,
               = innCustomer(d) EXTID 'ИННЮЛ' ATTR IN UPDExportA6_1_1,
               = kppCustomer(d) EXTID 'КПП' ATTR IN UPDExportA6_1_1    
               
    PROPERTIES = (regionCodeCustomer(d) IF regionCodeCustomer(d) AND NOT codeAdrressCustomer(d)) EXTID 'КодРегион' ATTR IN UPDExportA6_2_1                 
    PROPERTIES = (countryCodeAddressCustomer(d) IF NOT(regionCodeCustomer(d) OR codeAdrressCustomer(d))) EXTID 'КодСтр' ATTR IN UPDExportA6_2_2,
               = (adrressCustomer(d) IF NOT(regionCodeCustomer(d) OR codeAdrressCustomer(d))) EXTID 'АдрТекст' ATTR IN UPDExportA6_2_2   
    PROPERTIES = codeAdrressCustomer(d) EXTID 'КодГАР' IN UPDExportA6_2    
    
    PROPERTIES = (OVERRIDE codeBusinessEvent(d),'') EXTID 'Идентиф' ATTR IN UPDExportA9_1,
               = (OVERRIDE descriptionBusinessEvent(d),'') EXTID 'Значен' ATTR IN UPDExportA9_1    
    
    //--           
    OBJECTS detail = UpdDocumentDetail EXTID 'СведТов' IN UPDExportB
    FILTERS updDocument(detail)==d   
    
    PROPERTIES = (OVERRIDE INTEGER(number(detail)), defaultIndex(detail)) EXTID 'НомСтр' ATTR,
               = nameSku(detail) EXTID 'НаимТов' ATTR,
               = idUOM(detail) EXTID 'ОКЕИ_Тов' ATTR,
               = quantity(detail)  EXTID 'КолТов' ATTR,               
               = price(detail)  EXTID 'ЦенаТов' ATTR,               
               = sum(detail)  EXTID 'СтТовБезНДС' ATTR,       
               = nameVATStatus(detail)EXTID 'НалСт' ATTR,                       
               = invoiceSum(detail)  EXTID 'СтТовУчНал' ATTR                       
    
    PROPERTIES = dutySum(detail) EXTID 'СумАкциз' IN UPDExportB1           
    PROPERTIES = 'без акциза' IF withoutDuty(detail)  EXTID 'БезАкциз' IN UPDExportB1  
    
    PROPERTIES = VATSum(detail) EXTID 'СумНал' IN UPDExportB2           
    PROPERTIES = 'без НДС' IF NOT VATSum(detail)  EXTID 'БезНДС' IN UPDExportB2      
    //PROPERTIES = '-' IF NOT VATSum(detail)  EXTID 'ДефНДС' IN UPDExportB2   todo: Знак прочерка. Что это пока непонятно.
    
    PROPERTIES = idCountry(detail)  EXTID 'КодПроисх' ATTR IN UPDExportB3,      
               = numberDeclaration(detail)  EXTID 'НомерТД' ATTR IN UPDExportB3
       
    PROPERTIES = nameUOM(detail)  EXTID 'НаимЕдИзм' ATTR IN UPDExportB4,      
               = nameCountry(detail)  EXTID 'КрНаимСтрПр' ATTR IN UPDExportB4,
               = idSku(detail)  EXTID 'КодТов' ATTR IN UPDExportB4 
        
    PROPERTIES = sum(d) EXTID 'СтТовБезНДСВсего' ATTR IN UPDExportBB          
    PROPERTIES = invoiceSum(d)  EXTID 'СтТовУчНалВсего' ATTR IN UPDExportBB       
        
    PROPERTIES = VATSum(d) EXTID 'СумНал' IN UPDExportBB_1           
    PROPERTIES = 'без НДС' IF withoutVAT(d)  EXTID 'БезНДС' IN UPDExportBB_1      
    //PROPERTIES = '-' IF NOT VATSum(r)  EXTID 'ДефНДС' IN UPDExportBB   todo: Знак прочерка. Что это пока непонятно.  
            
    //--           
    PROPERTIES = (OVERRIDE description(d),'') EXTID 'СодОпер' ATTR IN UPDExportC1
    
    PROPERTIES = (OVERRIDE descriptionContract(d),'') EXTID 'НаимОсн' ATTR IN UPDExportC1_1,
               = numberContract(d) EXTID 'НомОсн' ATTR IN UPDExportC1_1,
               = toDateDDMMYYYY(dateContract(d)) EXTID 'ДатаОсн' ATTR IN UPDExportC1_1      
               
    PROPERTIES = ((OVERRIDE positionAgentSupplier(d),' ') IF isAgentSupplier(d)) EXTID 'Должность' ATTR IN UPDExportC1_2_1,        
               = ((OVERRIDE lastNameAgentSupplier(d),' ') IF isAgentSupplier(d)) EXTID 'Фамилия' ATTR IN UPDExportC1_2_1_1,      
               = ((OVERRIDE firsNameAgentSupplier(d),' ') IF isAgentSupplier(d)) EXTID 'Имя' ATTR IN UPDExportC1_2_1_1,  
               = (middleAgentSupplier(d) IF isAgentSupplier(d)) EXTID 'Отчество' ATTR IN UPDExportC1_2_1_1    
               
    PROPERTIES = ((OVERRIDE positionAgentExecuter(d),'') IF isAgentExecuter(d) AND NOT isAgentSupplier(d)) EXTID 'Должность' ATTR IN UPDExportC1_2_2_1,                                                                                 
               = ((OVERRIDE nameCompanyAgentExecuter(d),'') IF isAgentExecuter(d) AND NOT isAgentSupplier(d)) EXTID 'НаимОргПер' ATTR IN UPDExportC1_2_2_1               
    PROPERTIES = ((OVERRIDE lastNameAgentExecuter(d),'') IF isAgentExecuter(d) AND NOT isAgentSupplier(d)) EXTID 'Фамилия' ATTR IN UPDExportC1_2_2_1_1,      
               = ((OVERRIDE firsNametAgentExecuter(d),'') IF isAgentExecuter(d) AND NOT isAgentSupplier(d)) EXTID 'Имя' ATTR IN UPDExportC1_2_2_1_1,  
               = (middleNameAgentExecuter(d) IF isAgentExecuter(d) AND NOT isAgentSupplier(d)) EXTID 'Отчество' ATTR IN UPDExportC1_2_2_1_1 
               
    PROPERTIES = ((OVERRIDE lastNameExecuter(d),' ') IF NOT (isAgentExecuter(d) OR isAgentSupplier(d))) EXTID 'Фамилия' ATTR IN UPDExportC1_2_2_2_1, // todo: Есть еще должность. Что с ней делать непонятно.   
               = ((OVERRIDE firsNameExecuter(d),' ') IF NOT (isAgentExecuter(d) OR isAgentSupplier(d))) EXTID 'Имя' ATTR IN UPDExportC1_2_2_2_1,  
               = (middleNameExecuter(d) IF NOT (isAgentExecuter(d) OR isAgentSupplier(d))) EXTID 'Отчество' ATTR IN UPDExportC1_2_2_2_1   

    //-- Подписант
    PROPERTIES = nameSupplierSignerCredentials(d) EXTID 'ОблПолн' ATTR IN UPDExportD,
               = nameSupplierSignerStatus(d) EXTID 'Статус' ATTR IN UPDExportD,
               = supplierSignerCredentialsBase(d) EXTID 'ОснПолн' ATTR IN UPDExportD   
               
    PROPERTIES = supplierSignerLastName(d) IF isSupplierSigner(d)  EXTID 'Фамилия' ATTR IN UPDExportD_1_1,
               = supplierSignerFirstName(d) IF isSupplierSigner(d) EXTID 'Имя' ATTR IN UPDExportD_1_1,
               = supplierSignerMiddleName(d) IF isSupplierSigner(d) EXTID 'Отчество' ATTR IN UPDExportD_1_1   
               
    PROPERTIES = supplierSignerInn(d) IF NOT isSupplierSigner(d)  EXTID 'ИННЮЛ' ATTR IN UPDExportD_3,
               = supplierSignerPosition(d) IF NOT isSupplierSigner(d) EXTID 'Должн' ATTR IN UPDExportD_3            
    PROPERTIES = supplierSignerAgentLastName(d) IF NOT isSupplierSigner(d)  EXTID 'Фамилия' ATTR IN UPDExportD_3_1,
               = supplierSignerAgentFirstName(d) IF NOT isSupplierSigner(d) EXTID 'Имя' ATTR IN UPDExportD_3_1,
               = supplierSignerAgentMiddleName(d) IF NOT isSupplierSigner(d) EXTID 'Отчество' ATTR IN UPDExportD_3_1                                           
;

filePPR 'Файл схема ON_NSCHFDOPPR' = DATA FILE ();

saveFilePPR 'Загрузить файл оригинала' ()  { INPUT = filePPR() CHANGE; }
openFilePPR  'Просмотреть файл' ()  { open(filePPR()); }
deleteFilePPR  'Удалить файл' ()  { filePPR() <- NULL; } CONFIRM; 

EXTEND FORM options

    PROPERTIES() saveFilePPR
    PROPERTIES() SHOWIF filePPR() openFilePPR, deleteFilePPR
;

DESIGN options{
    pane{
        NEW upd{
            fill = 1;
            caption = 'УПД';
            NEW updScroll{
                fill = 1;
                NEW updPPR{
                    type = CONTAINERH;
                    caption = 'ON_NSCHFDOPPR';
                    MOVE PROPERTY (saveFilePPR());
                    MOVE PROPERTY (openFilePPR());
                    MOVE PROPERTY (deleteFilePPR());                          
                }          
            }
        }
    }       
}

exportUpdDocument 'Экспорт (xml)' (UpdDocument d){    
    generateIdFile(d);
    inReport(UpdDocument g)<- TRUE IF g==d;    
    EXPORT UPDPR XML  CHARSET 'windows-1251' TO xmlFile;
    //open(xmlFile());    
} TOOLBAR;
checkExportUpdDocument 'Проверка по схеме (xml)' (UpdDocument d){
    IF filePPR() THEN {
        generateIdFile(d);
        inReport(UpdDocument g)<- TRUE IF g==d;
        EXPORT UPDPR XML CHARSET 'WINDOWS-1251' TO System.exportFile;
        validateXML(filePPR(),System.exportFile());
        IF validateError() THEN {
            MESSAGE validateError() NOWAIT;
        } ELSE {
            MESSAGE 'Файл соответствует схеме' NOWAIT;
        }
    } ELSE {
        MESSAGE 'Не задан Файл схема ON_NSCHFDOPPR' NOWAIT;
    } 
} TOOLBAR;

checkAndExportUpdDocument 'Проверка и экспорт (xml)' (UpdDocument d) {
    IF filePPR() THEN {
        generateIdFile(d);
        inReport(UpdDocument g)<- TRUE IF g==d;
        EXPORT UPDPR XML TO System.exportFile;
        validateXML(filePPR(),System.exportFile());
        IF validateError() THEN {
            MESSAGE validateError() NOWAIT;
        } ELSE {
            open(System.exportFile());    
        }
    } ELSE {
        MESSAGE 'Не задан Файл схема ON_NSCHFDOPPR' NOWAIT;
    } 
} TOOLBAR;

EXTEND FORM updDocuments
    PROPERTIES (u) checkExportUpdDocument, checkAndExportUpdDocument
;
DESIGN updDocuments {
    NEW documentContainer BEFORE TOOLBARBOX {
        fill = 1;
        type = SPLITV;
        NEW body {
            fill = 1;
            NEW topFilters {  
                caption = 'Фильтры';
                alignment = STRETCH;
                type = CONTAINERH; 
                MOVE PROPERTY(filterDateFrom());
                MOVE PROPERTY(filterDateTo());                                                    
                MOVE PROPERTY(nameFilterSupplier()) { fill = 1; }
                MOVE PROPERTY(nameFilterCustomer()) { fill = 1; }                                            
            }
            MOVE BOX(u);
        }    
        NEW documentDetail {
            fill = 1;
            type = TABBED;

            MOVE BOX(d) {
                fill = 1;
                caption = 'Спецификация';
            }

            NEW actionContainer {
                caption = 'Действия';
                type = CONTAINERV;
                NEW export {
                    caption = 'Экспорт';
                    type = CONTAINERH;
                    MOVE PROPERTY(checkExportUpdDocument(u));           
                    MOVE PROPERTY(checkAndExportUpdDocument(u));                                     
                }

            }
        }
    }
}