MODULE CustomerEOrderTopBy;

REQUIRE CustomerEOrderTopByApi, TopBy;

NAMESPACE EDI;


DESIGN integrationData {
    col1TopBy {
        NEW ovs {
            caption = 'Заказы';
        }
    }
}

beforeSendPurchaseOrder(EOrder o, STRING[100] provider) + {
    IF provider == 'TopBy' THEN {
        lCodeUOM(EOrderDetail d) <- CASE 
            WHEN upper(extraCodeUOM(UOM(sku(d)))) == 'BO' THEN '868'
            WHEN upper(extraCodeUOM(UOM(sku(d)))) == 'H87' THEN 'PCE'
            WHERE order(d) ==o;
    }
}

sendPurchaseOrderTopBy (EOrder o) {
    checkIsServer();
    IF isServer() THEN {
        newNS() <- TRUE;
        sendPurchaseOrder(o, loginTopBy(customer(o)), passwordTopBy(customer(o)), ('http://' +  hostTopBy(customer(o)) + ':' + portTopBy(customer(o)) + '/DmcService'), outputDirTopBy(), 'TopBy');
    }
}

send(EOrder o) + { IF EDIProvider(supplier(o)) == EDIProvider.topBy AND NOT isCancel(o) THEN IF NOT toSend(o) THEN MESSAGE ('Заказ уже отправлен '+(OVERRIDE number(o), '')); ELSE {sendPurchaseOrderTopBy(o);} }
cancel(EOrder o) + {IF EDIProvider(supplier(o)) == EDIProvider.topBy AND isCancel(o) THEN IF exportedCanceled(o) THEN MESSAGE ('Заказ уже отменен '+(OVERRIDE number(o), '')); ELSE {sendPurchaseOrderTopBy(o);} }
