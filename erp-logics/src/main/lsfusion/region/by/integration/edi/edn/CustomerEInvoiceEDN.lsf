MODULE CustomerEInvoiceEDN;

REQUIRE EInvoiceEDN, CustomerEInvoiceTopByApi, EInvoiceEDSEDN;

NAMESPACE EDI;


signAndSendBlrapnCustomer(EInvoice e) + {
    IF EDIProviderInvoice(signSupplier(e), customer(e)) == EDIProvider.edn  THEN
        IF exportedBlrapnCustomer(e) THEN
            MESSAGE 'Извещение о прочтении (покупатель) уже отправлено';
            ELSE {
                hideMessageHeaderBlrapn() <- extractEDN(customer(e));
                signAndSendBlrapnCustomerEInvoice(e, loginEDN(customer(e)), passwordEDN(customer(e)), ('https://' + hostEDN(customer(e)) +':' + portEDN(customer(e)) + '/topby/DmcService?wsdl'), outputDirEDN(), 'EDN', TRUE);
            }
}

signAndSendCustomer(EInvoice e) + {
    IF EDIProviderInvoice(signSupplier(e), customer(e)) == EDIProvider.edn  THEN
        IF (exportedCustomer(e) OR exportedNoticeCustomer(e)) THEN MESSAGE 'Накладная (покупатель) или уведомление об изменении уже отправлены';
        ELSE IF isTN2(e) THEN {
            hideMessageHeaderBlrdnr() <- extractEDN(customer(e));
            signAndSendCustomerEInvoiceTN2(e, loginEDN(customer(e)), passwordEDN(customer(e)), ('https://' + hostEDN(customer(e)) +':' + portEDN(customer(e)) + '/topby/DmcService?wsdl'), outputDirEDN(), 'EDN');
        } ELSE {
            hideMessageHeaderBlrwbr() <- extractEDN(customer(e));
            signAndSendCustomerEInvoice(e, loginEDN(customer(e)), passwordEDN(customer(e)), ('https://' + hostEDN(customer(e)) +':' + portEDN(customer(e)) + '/topby/DmcService?wsdl'), outputDirEDN(), 'EDN');
        }
}

signAndSendNoticeCustomer(EInvoice e, STRING[1000] d) + {
    IF EDIProviderInvoice(signSupplier(e), customer(e)) == EDIProvider.edn  THEN
        IF (exportedCustomer(e) OR exportedNoticeCustomer(e)) THEN MESSAGE 'Накладная (покупатель) или уведомление об изменении уже отправлены';
        ELSE IF isTN2(e) THEN {
            hideMessageHeaderBlrapn() <- extractEDN(customer(e));
            signAndSendNoticeCustomerEInvoiceTN2(e, d, loginEDN(customer(e)), passwordEDN(customer(e)), ('https://' + hostEDN(customer(e)) +':' + portEDN(customer(e)) + '/topby/DmcService?wsdl'), outputDirEDN(), 'EDN');
        } ELSE {
            hideMessageHeaderBlrapn() <- extractEDN(customer(e));
            signAndSendNoticeCustomerEInvoice(e, d, loginEDN(customer(e)), passwordEDN(customer(e)), ('https://' + hostEDN(customer(e)) +':' + portEDN(customer(e)) + '/topby/DmcService?wsdl'), outputDirEDN(), 'EDN');
        }
}

signAndSendCustomer(ECreditNote c) + {
    IF EDIProviderInvoice(supplier(c), customer(c)) == EDIProvider.edn  THEN {
        IF exportedCustomer(c) THEN
            MESSAGE 'Акт приемки (покупатель) уже отправлен';
        ELSE {
            hideMessageHeaderBlradf() <- extractEDN(customer(c));
            signAndSendCustomerECreditNote(c, loginEDN(customer(c)), passwordEDN(customer(c)), ('https://' + hostEDN(customer(c)) +':' + portEDN(customer(c)) + '/topby/DmcService?wsdl'), outputDirEDN(), 'EDN');
        }
    }
}

signAndSendBlrapnCustomer(ECreditNote c) + {
    IF EDIProviderInvoice(supplier(c), customer(c)) == EDIProvider.edn THEN {
        IF exportedBlrapnCustomer(c) THEN
            MESSAGE 'Извещение о прочтении (покупатель) уже отправлено';
        ELSE {
            hideMessageHeaderBlradf() <- extractEDN(customer(c));
            signAndSendBlrapnCustomerECreditNote(c, loginEDN(customer(c)), passwordEDN(customer(c)), ('https://' + hostEDN(customer(c)) +':' + portEDN(customer(c)) + '/topby/DmcService?wsdl'), outputDirEDN(), 'EDN');
        }
    }
}