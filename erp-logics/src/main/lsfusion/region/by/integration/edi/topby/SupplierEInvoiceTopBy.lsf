MODULE SupplierEInvoiceTopBy;

REQUIRE SupplierEInvoiceTopByApi, EDSTopBy, EInvoiceTopBy;


signAndSendSupplier(EInvoice e) + {
    IF EDIProviderInvoice(customer(e), supplier(e)) == EDIProvider.topBy THEN
        IF exportedSupplier(e) THEN MESSAGE 'Накладная (поставщик) уже отправлена';
        ELSE IF isTN2(e) THEN {
            signAndSendSupplierEInvoiceTN2(e, loginTopBy(supplier(e)), passwordTopBy(supplier(e)), ('http://' + hostTopBy(supplier(e)) +':' + portTopBy(supplier(e)) + '/DmcService'), (OVERRIDE overInvoiceOutputDirTopBy(e),outputDirTopBy()), 'TopBy');
        } ELSE {
            signAndSendSupplierEInvoice(e, loginTopBy(supplier(e)), passwordTopBy(supplier(e)), ('http://' + hostTopBy(supplier(e)) +':' + portTopBy(supplier(e)) + '/DmcService'), (OVERRIDE overInvoiceOutputDirTopBy(e),outputDirTopBy()), 'TopBy');
        }
}

signAndSendBlrapnSupplier(EInvoice e) + {
    IF EDIProviderInvoice(customer(e), supplier(e)) == EDIProvider.topBy THEN
        IF exportedBlrapnSupplier(e) THEN MESSAGE 'Извещение о прочтении (поставщик) уже отправлено';
        ELSE IF isTN2(e) THEN {
            signAndSendBlrapnSupplierEInvoiceTN2(e, loginTopBy(supplier(e)), passwordTopBy(supplier(e)), ('http://' + hostTopBy(supplier(e)) +':' + portTopBy(supplier(e)) + '/DmcService'), outputDirTopBy(), overInvoiceOutputDirTopBy(e), 'TopBy');
        } ELSE {
            signAndSendBlrapnSupplierEInvoice(e, loginTopBy(supplier(e)), passwordTopBy(supplier(e)), ('http://' + hostTopBy(supplier(e)) +':' + portTopBy(supplier(e)) + '/DmcService'), outputDirTopBy(), overInvoiceOutputDirTopBy(e), 'TopBy');
        }
}

EXTEND FORM exportBlrwbl
    OBJECTS eeint = EInvoice BEFORE d EXTID 'ExtraField'
    FILTERS eeint == ei
    PROPERTIES DRAW ein  fieldName = IF isReturn(eeint) AND EDIProviderInvoice(customer(eeint), supplier(eeint)) = EDIProvider.topBy THEN 'Признак возвратной накладной' EXTID 'FieldName',
        fieldCode = IF isReturn(eeint) AND EDIProviderInvoice(customer(eeint), supplier(eeint)) = EDIProvider.topBy THEN 'PW0013' EXTID 'FieldCode',
        fieldValue = IF isReturn(eeint) AND EDIProviderInvoice(customer(eeint), supplier(eeint)) = EDIProvider.topBy THEN '1' EXTID 'FieldValue'
;

EXTEND FORM exportBlrdln
    OBJECTS eeint = EInvoice BEFORE d EXTID 'ExtraField'
    FILTERS eeint == ei
    PROPERTIES DRAW ein  fieldName = IF isReturn(eeint) AND EDIProviderInvoice(customer(eeint), supplier(eeint)) = EDIProvider.topBy THEN 'Признак возвратной накладной' EXTID 'FieldName',
        fieldCode = IF isReturn(eeint) AND EDIProviderInvoice(customer(eeint), supplier(eeint)) = EDIProvider.topBy THEN 'PW0013' EXTID 'FieldCode',
        fieldValue = IF isReturn(eeint) AND EDIProviderInvoice(customer(eeint), supplier(eeint)) = EDIProvider.topBy THEN '1' EXTID 'FieldValue'
;