MODULE SupplierEInvoiceTopBy;

REQUIRE EInvoiceTopBy, SupplierEInvoiceTopByApi, EInvoiceEDSTopBy;


signAndSendSupplier(EInvoice e) + {
    IF EDIProviderInvoice(customer(e), supplier(e)) == EDIProvider.topBy AND NOT skipSendSupplier(e) THEN {
        newNS() <- TRUE;
        IF exportedSupplier(e) THEN 
            MESSAGE 'Накладная (поставщик) уже отправлена';
        ELSE IF isTN2(e) THEN {
            signAndSendSupplierEInvoiceTN2(e, loginTopBy(supplier(e)), passwordTopBy(supplier(e)), ('http://' + hostTopBy(supplier(e)) +':' + portTopBy(supplier(e)) + '/DmcService'), (OVERRIDE overInvoiceOutputDirTopBy(e),outputDirTopBy()), 'TopBy');
        } ELSE {
            signAndSendSupplierEInvoice(e, loginTopBy(supplier(e)), passwordTopBy(supplier(e)), ('http://' + hostTopBy(supplier(e)) +':' + portTopBy(supplier(e)) + '/DmcService'), (OVERRIDE overInvoiceOutputDirTopBy(e),outputDirTopBy()), 'TopBy');
        }
    }
}

signAndSendBlrapnSupplier(EInvoice e) + {
    IF EDIProviderInvoice(customer(e), supplier(e)) == EDIProvider.topBy AND NOT skipSendSupplier(e) THEN {
        newNS() <- TRUE;
        IF exportedBlrapnSupplier(e) THEN 
            MESSAGE 'Извещение о прочтении (поставщик) уже отправлено';
        ELSE {
            signAndSendBlrapnSupplierEInvoice(e, loginTopBy(supplier(e)), passwordTopBy(supplier(e)), ('http://' + hostTopBy(supplier(e)) +':' + portTopBy(supplier(e)) + '/DmcService'), (OVERRIDE overInvoiceOutputDirTopBy(e), outputDirTopBy()), 'TopBy', TRUE);
        }
    }
}


signAndSendSupplier(ECreditNote c) + {
    IF EDIProvider(customer(c)) == EDIProvider.topBy THEN {
        newNS() <- TRUE;
        IF exportedSupplier(c) THEN MESSAGE 'Акт приемки (поставщик) уже отправлен';
        ELSE MESSAGE 'Отправка ответа на акт приемки не поддерживается'; 
            //signAndSendSupplierECreditNote(c,loginTopBy(supplier(c)), passwordTopBy(supplier(c)), ('http://' + hostTopBy(supplier(c)) +':' + portTopBy(supplier(c)) + '/DmcService'), outputDirTopBy(), 'TopBy');
    }
}

