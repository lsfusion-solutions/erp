MODULE EInvoice;

REQUIRE EDI;

NAMESPACE EDI;

//первый это поставщик или покупатель, второй - мы
dataEDIProviderInvoice 'EDI-провайдер для накладных' = DATA EDIProvider (LegalEntity, LegalEntity);
EDIProviderInvoice 'EDI-провайдер для накладных' (LegalEntity legalEntity, LegalEntity company) = OVERRIDE dataEDIProviderInvoice(legalEntity, company), EDIProvider(legalEntity);
nameEDIProviderInvoice 'EDI-провайдер для накладных' (LegalEntity legalEntity, LegalEntity company) = staticCaption(EDIProviderInvoice(legalEntity, company));

EXTEND FORM legalEntity
    PROPERTIES nameEDIProviderInvoice(l, eCom);

DESIGN legalEntity {
    EDI {
        NEW EInvoice {
            type = CONTAINERV;
            caption = 'Накладные';
        }
    }   
}


@openXML(EInvoice,e,eInvoices);

@openXML(EInvoiceMessage,m,eInvoices);

GROUP deliveryNote EXTID 'DeliveryNote';
GROUP shipper EXTID 'Shipper';
GROUP receiver EXTID 'Receiver';
GROUP shipTo EXTID 'ShipTo';

// формы импорта/экспорта APN
GROUP messageHeader EXTID 'MessageHeader';
GROUP acknowledgement EXTID 'Acknowledgement';
GROUP referenceDocument EXTID 'ReferenceDocument';
GROUP blrapnReferenceDocument EXTID 'ReferenceDocument': acknowledgement;
GROUP blrapnShipper EXTID 'Shipper': acknowledgement;
GROUP blrapnReceiver EXTID 'Receiver': acknowledgement;
GROUP blrapnErrorOrAcknowledgement EXTID 'ErrorOrAcknowledgement': acknowledgement;
blrapnTestIndicator = DATA LOCAL NESTED STRING[1]();
blrapnUserID = DATA LOCAL NESTED STRING[35]();
blrapnDocumentNumber = DATA LOCAL NESTED STRING[35]();
blrapnDateTime = DATA LOCAL NESTED DATETIME();
blrapnMsgSender = DATA LOCAL NESTED STRING[13]();
blrapnMsgReceiver = DATA LOCAL NESTED STRING[13]();
blrapnDeliveryNoteId = DATA LOCAL NESTED STRING[70]();
blrapnDeliveryNoteDate = DATA LOCAL NESTED DATE();
blrapnReferenceDocumentType = DATA LOCAL NESTED STRING[6]();
blrapnReferenceDocumentId = DATA LOCAL NESTED STRING[70]();
blrapnReferenceDocumentDate = DATA LOCAL NESTED DATETIME();
blrapnShipper = DATA LOCAL NESTED STRING[48]();
blrapnReceiver = DATA LOCAL NESTED STRING[48]();
blrapnCode = DATA LOCAL NESTED STRING[8]();
blrapnDescription = DATA LOCAL NESTED STRING[1000]();

FORM importBlrapn
    PROPERTIES() IN messageHeader blrapnTestIndicator EXTID 'TestIndicator', blrapnUserID EXTID 'UserID'
    PROPERTIES() IN acknowledgement blrapnDocumentNumber EXTID 'DocumentID', blrapnDateTime EXTID 'CreationDateTime',
        blrapnDeliveryNoteId EXTID 'DeliveryNoteID', blrapnDeliveryNoteDate EXTID 'DeliveryNoteDate'
    PROPERTIES() IN blrapnReferenceDocument blrapnReferenceDocumentType EXTID 'Type'
    PROPERTIES() IN blrapnReceiver blrapnReceiver EXTID 'GLN'
    PROPERTIES() IN blrapnErrorOrAcknowledgement blrapnCode EXTID 'Code', blrapnDescription EXTID 'Description'
;

hideMessageHeaderBlrapn = DATA LOCAL BOOLEAN ();

FORM exportBlrapn FORMEXTID 'BLRAPN'
    PROPERTIES ATTR ='0.1' IF NOT hideMessageHeaderBlrapn() EXTID 'version'
    PROPERTIES IN messageHeader
    messageId = resultMilliseconds() IF NOT hideMessageHeaderBlrapn() EXTID 'MessageID',
        msgDateTime = toChar(blrapnDateTime(),'YYYYMMDDHH24MISS') IF NOT hideMessageHeaderBlrapn() EXTID 'MsgDateTime',
        messageType = 'BLRAPN' IF NOT hideMessageHeaderBlrapn() EXTID 'MessageType',
        msgSenderID = blrapnMsgSender() IF NOT hideMessageHeaderBlrapn() EXTID 'MsgSenderID',
        msgReceiverID = blrapnMsgReceiver() IF NOT hideMessageHeaderBlrapn() EXTID 'MsgReceiverID',
        userID = blrapnUserID() IF NOT hideMessageHeaderBlrapn() EXTID 'UserID'
    PROPERTIES IN acknowledgement
    documentId = resultMilliseconds() EXTID 'DocumentID',
        functionCode = '6' EXTID 'FunctionCode',
        creationdateTime = toChar(blrapnDateTime(),'YYYYMMDDHH24MISS') EXTID 'CreationDateTime',
        blrapnDeliveryNoteId() EXTID 'DeliveryNoteID',
        deliveryNoteDate = toChar(blrapnDeliveryNoteDate(),'YYYYMMDD') EXTID 'DeliveryNoteDate',
        blrapnReferenceDocumentType() EXTID 'Type' IN blrapnReferenceDocument,
        blrapnReferenceDocumentId() EXTID 'ID' IN blrapnReferenceDocument,
        date = toChar(blrapnReferenceDocumentDate(),'YYYYMMDDHH24MISS') EXTID 'Date' IN blrapnReferenceDocument,
        blrapnShipper() EXTID 'GLN' IN blrapnShipper,
        blrapnReceiver() EXTID 'GLN' IN blrapnReceiver,
        blrapnCode() EXTID 'Code' IN blrapnErrorOrAcknowledgement,
        blrapnDescription() EXTID 'Description' IN blrapnErrorOrAcknowledgement
;

// формы импорта/экспорта WBR
