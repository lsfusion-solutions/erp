MODULE ImportTNVEDTracking;

REQUIRE ImportTNVED, ItemTracking;

importExtraCode 'Импортировать 4-зн. код (файл TNVED_AD.DBF)' () {
    INPUT f = FILE DO NEWSESSION {
        LOCAL tnved = STRING (INTEGER);
        LOCAL id = STRING[4] (INTEGER);
        LOCAL lvl1 = STRING (INTEGER);
        LOCAL lvl2 = STRING (INTEGER);
        LOCAL lvl3 = STRING (INTEGER);
        LOCAL lvl4 = STRING (INTEGER);
        LOCAL isTracking = STRING (INTEGER);

        IMPORT DBF CHARSET 'CP866' FROM f TO tnved = CODETNVED, id = CODEADD, lvl1 = N1, lvl2 = N2, lvl3 = N3, lvl4 = N4, isTracking = PSM537;

        FOR imported(INTEGER i) AND i > 1 AND customsGroup(tnved(i)) AND ExtraCode ec == extraCode(customsGroup(tnved(i)), id(i)) DO {
            isTracking(ec) <- IF isTracking(i) == '1' THEN TRUE ELSE NULL;
        }

        FOR imported(INTEGER i) AND i > 1 AND customsGroup(tnved(i)) AND NOT extraCode(customsGroup(tnved(i)), id(i)) DO NEW ec = ExtraCode {
            customsGroup(ec) <- customsGroup(tnved(i));
            id(ec) <- id(i);
            description(ec) <- STRING[150](CONCAT '/', lvl1(i), lvl2(i), lvl3(i), lvl4(i));
            isTracking(ec) <- TRUE IF isTracking(i) == '1';
        }

        FOR code(CustomsGroup c) AND NOT countExtraCodes(c) DO NEW ec = ExtraCode {
            customsGroup(ec) <- c;
            id(ec) <- '0000';
        }

        APPLY;
    }
} IN tnved;


EXTEND FORM defaultData
    PROPERTIES()  importExtraCode
;
DESIGN defaultData {
    customs {
        MOVE PROPERTY(importExtraCode());
    }
}

setUOMSPT 'Задать ед измерения кодам ТН ВЭД (пост.25.11.2024г. № 877 с изм 25.09.25)'()  {
    FOR code(CustomsGroup c) =='8418102001' 
        OR code(c) =='8418108001' OR code(c) =='8418211000' OR code(c) =='8418215100' OR code(c) =='8418215900' OR code(c) =='8418219100' OR code(c) =='8418219900'
        OR code(c) =='8418302001' OR code(c) =='8418308001' OR code(c) =='8418402001' OR code(c) =='8418408001' OR code(c) =='8418290000' OR code(c) =='4011100003'
        OR code(c) =='4011100009' OR code(c) =='4011201000' OR code(c) =='4011209000' OR code(c) =='4011400000' OR code(c) =='4011700000' OR code(c) =='4011800000'
        OR code(c) =='4011900000' OR code(c) =='8711601000' OR code(c) =='8711609000' OR code(c) =='8712003000' OR code(c) =='8712007000' OR code(c) =='8714911007'
        OR code(c) =='9503001009' OR code(c) =='8450111100' OR code(c) =='8450111900' OR code(c) =='8450119000' OR code(c) =='8450120000' OR code(c) =='8450190000'
        OR code(c) =='8450200000' OR code(c) =='8508110000' OR code(c) =='8508190001' OR code(c) =='8508190009' OR code(c) =='8508110000' OR code(c) =='8508190001'
        OR code(c) =='8508190009' OR code(c) =='8516400000' OR code(c) =='8509400000' OR code(c) =='8422110000' OR code(c) =='8516797000' OR code(c) =='8516797000'
        OR code(c) =='8516500000' OR code(c) =='8516601010' OR code(c) =='8516605000' OR code(c) =='8467211000' OR code(c) =='8467219100' OR code(c) =='8467219900'
        OR code(c) =='8516310009' OR code(c) =='8528711100' OR code(c) =='8528711500' OR code(c) =='8528711900' OR code(c) =='8528719100' OR code(c) =='8528719900'
        OR code(c) =='8528721000' OR code(c) =='8528722001' OR code(c) =='8528722009' OR code(c) =='8528723001' OR code(c) =='8528723002' OR code(c) =='8528723003'
        OR code(c) =='8528723009' OR code(c) =='8528724000' OR code(c) =='8528726000' OR code(c) =='8528728000' OR code(c) =='8528730000' OR code(c) =='8418109000'
        OR code(c) =='8418290000'
        DO {
            dataTrackingUOM(c) <- '796' WHERE NOT trackingUOM(c); // шт
            isTracking(extraCode(c)) <- TRUE  WHERE id(extraCode(c))=='0000' AND countExtraCodes(c)=1 AND NOT isTracking(extraCode(c));
    }
    APPLY ;
}

setDateSPT 'Задать даты начала прослеживаемости (пост.25.11.2024г. № 877 с изм 25.09.25)'() {
    FOR code(CustomsGroup c) == '8418290000'
        OR code(c) == '8450111100' OR code(c) == '8450111900' OR code(c) == '8450119000' OR code(c) == '8450120000' OR code(c) == '8450190000' OR code(c) == '8450200000' 
        OR code(c) == '8508110000' OR code(c) == '8508190001' OR code(c) == '8508190009' OR code(c) == '8516400000' OR code(c) == '8509400000' OR code(c) == '8422110000'
        OR code(c) == '8516797000' OR code(c) == '8516500000' OR code(c) == '8516601010' OR code(c) == '8516605000' OR code(c) == '8467211000' OR code(c) == '8467219100'
        OR code(c) == '8467219900' OR code(c) == '8516310009' OR code(c) == '8528711100' OR code(c) == '8528711500' OR code(c) == '8528711900' OR code(c) == '8528719100'
        OR code(c) == '8528719900' OR code(c) == '8528721000' OR code(c) == '8528722001' OR code(c) == '8528722009' OR code(c) == '8528723001' OR code(c) == '8528723002'
        OR code(c) == '8528723003' OR code(c) == '8528723009' OR code(c) == '8528724000' OR code(c) == '8528726000' OR code(c) == '8528728000' OR code(c) == '8528730000'
        OR code(c) == '8418109000' OR code(c) == '8418290000'
        DO {
            dateStartSPT(c) <- 2026_03_01;
        }
    
    FOR code(CustomsGroup c) == '8418102001' OR code(c) == '8418108001' OR code(c) == '8418211000' OR code(c) == '8418215100' OR code(c) == '8418215900' OR code(c) == '8418219100'
        OR code(c) == '8418219900' OR code(c) == '8418302001' OR code(c) == '8418308001' OR code(c) == '8418402001' OR code(c) == '8418408001' OR code(c) == '4011100003'
        OR code(c) == '4011100009' OR code(c) == '4011201000' OR code(c) == '4011209000' OR code(c) == '4011400000' OR code(c) == '4011700000' OR code(c) == '4011800000'
        OR code(c) == '4011900000' DO {
        dateStartSPT(c) <- 2021_12_01;
    }

    FOR code(CustomsGroup c) == '8711601000' OR code(c) == '8711609000' OR code(c) == '8712003000' OR code(c) == '8712007000' OR code(c) == '8714911007' OR code(c) == '9503001009' DO {
        dateStartSPT(c) <- 2022_12_01;
    }
    APPLY ;
}



EXTEND FORM defaultData
    PROPERTIES()  setUOMSPT, setDateSPT
;

DESIGN defaultData {
    customs {
        MOVE PROPERTY (setUOMSPT());
        MOVE PROPERTY (setDateSPT());
    }
}