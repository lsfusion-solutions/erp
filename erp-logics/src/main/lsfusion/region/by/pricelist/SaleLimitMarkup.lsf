MODULE SaleLimitMarkup;

REQUIRE SaleInvoice, PriceListCalc, SaleManufacturingPrice;

NAMESPACE Sale;

limitSaleCalcPriceListType 'Предельная цена от цены изготовителя' = DATA CalcPriceListType() PREREAD;
nameLimitSaleCalcPriceListType 'Предельная цена от цены изготовителя' () = name(limitSaleCalcPriceListType());

EXTEND FORM options
    PROPERTIES() nameLimitSaleCalcPriceListType
;
DESIGN options {
    invoiceSale {
        MOVE PROPERTY(nameLimitSaleCalcPriceListType());
    }
}

limitSaleMarkupPrice(UserOrderDetail d) = round([ X*(Y+100)*(Z+100)/10000](
                                              manufacturingPrice(d),
                                              markup(limitSaleCalcPriceListType(), sku(d)),
                                              valueVAT(d)), roundCondition(limitSaleCalcPriceListType())); 

WHEN LOCAL FORMS userOrder GOAFTER price[UserOrderDetail]
           (CHANGED(price(UserOrderDetail d)) OR CHANGED(sku(d)) OR CHANGED(manufacturingPrice(d)) OR SET(showManufacturingPrice(d))) AND
           showManufacturingPrice(d) AND limitSaleMarkupPrice(d) < price(d) DO {
    price(d) <- limitSaleMarkupPrice(d);          
    invoicePrice(d) <- round2(limitSaleMarkupPrice(d) * (100.0 (+) valueVAT(d)) / 100.0);
}

limitSaleMarkupPrice(UserInvoiceDetail d) = round([ X*(Y+100)*(Z+100)/10000](
                                              manufacturingPrice(d),
                                              markup(limitSaleCalcPriceListType(), sku(d)),
                                              valueVAT(d)), roundCondition(limitSaleCalcPriceListType())); 

WHEN LOCAL FORMS userInvoice GOAFTER price[UserInvoiceDetail]
           (CHANGED(price(UserInvoiceDetail d)) OR CHANGED(sku(d)) OR CHANGED(manufacturingPrice(d)) OR SET(showManufacturingPrice(d))) AND
           showManufacturingPrice(d) AND limitSaleMarkupPrice(d) < price(d) DO {
    price(d) <- limitSaleMarkupPrice(d);          
    invoicePrice(d) <- round2(limitSaleMarkupPrice(d) * (100.0 (+) valueVAT(d)) / 100.0);
}
           