MODULE PurchasePriceLimitUp;

REQUIRE PricingPurchase;

NAMESPACE Purchase;

@defineOption(enablePriceLimitUp, 'Запретить рост цен', pricings);

allowPriceUp 'Разрешить рост цены' = DATA BOOLEAN (UserInvoice);
EXTEND FORM userInvoice
    PROPERTIES(i) allowPriceUp SHOWIF enablePriceLimitUp()
;
     
DESIGN userInvoice {
    headerCreatePricing {
         MOVE PROPERTY(allowPriceUp(i));
    }
}


WHEN FORMS userInvoice GOAFTER retailPrice[UserInvoiceDetail] 
            (SETCHANGED(retailPrice(UserInvoiceDetail d)) OR SET(isPosted(d)) OR SETCHANGED(dateTime(d)) OR SETCHANGED(customerStock(d)) OR SETCHANGED(sku(d))) 
            AND isPosted(d) AND enablePriceLimitUp() AND NOT allowPriceUp(userInvoice(d)) NOINLINE DO {
    IF retailPrice(d) > prevRetailPricingPriceB(sku(d), customerStock(d), dateTime(d)) THEN {
        MESSAGE 'Запрет роста цен по товару ' + nameSku(d) + ' c ' + prevRetailPricingPriceB(sku(d), customerStock(d), dateTime(d)) + ' до ' + retailPrice(d) + '\nОбратитесь в отдел ЦО' NOWAIT;
        CANCEL;
    }
}
