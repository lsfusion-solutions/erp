MODULE ImportAxaptaRange;

REQUIRE ImportAxapta, RangeLevel;

NAMESPACE ImportAxapta;

importRange 'Импорт ассортиментных матриц' () {
    NEWSESSION {
        LOCAL file = FILE ();    
        LOCAL shopGroupId = STRING[20](INTEGER);
        LOCAL itemId = STRING[10](INTEGER);
        
        IF csvImport() THEN {
            INPUT f = CSVFILE DO {
                IMPORT CSV ';' HEADER NOESCAPE FROM f TO shopGroupId, itemId;
            }
        } ELSE {
            EXTERNAL SQL connectionString() 
                EXEC 'SELECT SHOPGROUPID, ITEMID FROM RETAILSHOPGROUPITEM' TO file;
                IMPORT TABLE FROM file() TO shopGroupId, itemId;
        }
        FOR Range.name(Range.range(RangeRev rr)) = shopGroupId(INTEGER i) DO level(rr, Item item) <- NULL;
        FOR Range.name(Range.range(RangeRev rr)) = shopGroupId(INTEGER i) AND Item item = item(itemId(i)) DO {
            level(rr, item) <- rangeLevel('1');
        }
    APPLY;
    }
}

EXTEND FORM integrationData
    PROPERTIES() importRange
;
    
DESIGN integrationData {
    axaptaButtons {
        NEW importItemGroupCont {
            type = CONTAINERH;
            MOVE PROPERTY (importRange());
        }
    }
}

createRangeStoreType(){
    FOR name(StoreType st) DO NEW range = Range.Range {
        name(range)<- substr(id(st),2,50);
        in(range, rangeLevel('1')) <- TRUE;
        inData(range, SkuGroup sg) <- TRUE IF sg = itemGroup('07Отд00000001');
    
        dataLevel(range, st, DATE date) <- rangeLevel('1');
               NEW rr = RangeRev {
        range(rr)<- range;
        dateTime(rr) <- DATETIME (2020_01_01);
                }
            }
    APPLY;
}