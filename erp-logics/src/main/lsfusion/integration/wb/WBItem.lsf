MODULE WBItem;

REQUIRE WBMasterData, System;

NAMESPACE WB;

CLASS Item 'Товар';

itemSubGroup = DATA ItemSubGroup (Item);

CLASS ABSTRACT Attribute 'Атрибут';
TABLE attribute (Attribute) FULL;

CLASS AttributeClass 'Тип атрибута';
TABLE attributeClass (AttributeClass);

name '{master.data.name}' (AttributeClass o) = staticCaption(o) IF o IS AttributeClass CHARWIDTH 15;
order = ABSTRACT CASE INTEGER (AttributeClass);

FORM dialogAttributeClasss 'Тип атрибута'
    OBJECTS o = AttributeClass
    PROPERTIES(o) READONLY name, order SHOWIF NULL
    ORDERS order(o)    

    LIST AttributeClass OBJECT o
;

newAttribute 'Новый' ABSTRACT CASE (AttributeClass);
newAttribute 'Новый' () {
    DIALOG dialogAttributeClasss OBJECTS o INPUT DO {
        newAttribute(o);
    }
} TOOLBAR IMAGE 'add.png';

nameClass 'Тип атрибута' (Attribute a) = objectClassName(a) CHARWIDTH 20;

id 'Код' = ABSTRACT STRING[50] (Attribute) MATERIALIZED NONULL INDEXED CHARWIDTH 15 IN id;
attribute 'Атрибут' (STRING[10] id) = GROUP AGGR Attribute a BY id(a);

active 'Вкл.' = ABSTRACT BOOLEAN (Attribute);
isObject 'Объектный' = ABSTRACT BOOLEAN (Attribute);

name 'Наименование атрибута' = ABSTRACT STRING[50] (Attribute) NONULL IN id;

in 'Вкл.' = DATA BOOLEAN (ItemSubGroup, Attribute);
notNull 'Обязательный' = DATA BOOLEAN (ItemSubGroup, Attribute);

value 'Значение' = ABSTRACT STRING (Item, Attribute);
idValue 'id значения' = ABSTRACT STRING (Item, Attribute);
objectValue 'Объект значения' = ABSTRACT Object (Item, Attribute);

CONSTRAINT (DROPPED(value(Item o, Attribute a)) OR SET(in(itemSubGroup(o), a)) AND NOT value(o, a)) AND PREV(notNull(itemSubGroup(o), a)) OR
    SET(o IS Item) AND a IS Attribute AND NOT value(o, a) AND notNull(itemSubGroup(o), a)
    MESSAGE 'Не заполнен обязательный атрибут';

edit 'Редактировать' ABSTRACT (Item, Attribute);
set 'Установить' ABSTRACT (Item, Attribute, STRING);

FORM attributes 'Атрибуты'
    OBJECTS attr = Attribute 
    PROPERTIES (attr) READONLY id, name, nameClass
    PROPERTIES (attr) NEWSESSION EDIT, DELETE
    PROPERTIES NEWSESSION newAttribute() DRAW attr

    FILTERGROUP active
        FILTER 'Активные' active(attr) DEFAULT

    OBJECTS ownerClass = ItemSubGroup
    PROPERTIES in(ownerClass, attr) COLUMNS (ownerClass) HEADER name(ownerClass)

    OBJECTS extraProp = ItemSubGroup
    PROPERTIES name(extraProp) READONLY
    PROPERTIES (extraProp, attr) notNull
;

DESIGN attributes {
    OBJECTS {
        NEW tabbedPane {
            tabbed = TRUE;
            fill = 1;
            MOVE BOX(extraProp) { caption = 'Настройки'; }
        }
    }
}  

NAVIGATOR {
    NEW FORM attributes;
}

FORM itemSubGroup 'Предмет'
    OBJECTS i = Item PANEL 
//    PROPERTIES(i) id, name, idItemGroup, nameItemGroup
//    ORDERS name(i)

    OBJECTS attr = Attribute
    PROPERTIES value(i, attr) ON CHANGE { edit(i, attr); } SHOWIF in(itemSubGroup(i), attr) COLUMNS (attr) HEADER name(attr)

    EDIT Item OBJECT i
;

//------------------------------------ String ----------------------------------------------------------------------//

CLASS AttributeString 'Строковый атрибут' : Attribute;
EXTEND CLASS AttributeClass { string 'Строка' }
newAttribute(AttributeClass c) + WHEN c = AttributeClass.string THEN {
    NEW a = AttributeString {
        edit(a);
    }
};
order(AttributeClass c) += WHEN c == AttributeClass.string THEN 1;
id 'Код' = DATA STRING[50] (AttributeString) NONULL CHARWIDTH 15 IN id;
inactive 'Выкл.' = DATA BOOLEAN (AttributeString);
name 'Наименование' = DATA STRING[50] (AttributeString) NONULL IN id;
id (AttributeString a) += id(a);
active (AttributeString a) += a IS AttributeString AND NOT inactive(a);
name (AttributeString a) += name(a);
value 'Значение' = DATA STRING (Item, AttributeString);
value (Item o, AttributeString a) += value(o, a);
edit (Item o, AttributeString a) + {
    INPUT s = STRING DO {
        value(o, a) <- s;
    }
}
set (Item o, AttributeString a, STRING v) + {
    value(o, a) <- v;
}
// Дополнительные ограничения
regex 'Шаблон (regex)' = DATA STRING (AttributeString) IN id;
CONSTRAINT SETCHANGED(value(Item o, AttributeString i)) AND regex(i) AND NOT regexPatternMatch(value(o, i), regex(i)) 
    MESSAGE CONCAT ' ','Значение атрибута не соответствует шаблону';

FORM attributeString 'Атрибут (строка)'
    OBJECTS attr = AttributeString PANEL
    PROPERTIES (attr) id, name, inactive, regex
    EDIT AttributeString OBJECT attr
;
DESIGN attributeString {
    caption = CONCAT ' - ', 'Атрибут (строка)', name(attr);
    OBJECTS {
        NEW constaraints {
            caption = 'Ограничения';
            horizontal = TRUE;
            fill = 1;
            MOVE PROPERTY(regex(attr)){align = START;};
        }
    }
}

//------------------------------------ Integer ----------------------------------------------------------------------//

CLASS AttributeInteger 'Целочисленный атрибут' : Attribute;
EXTEND CLASS AttributeClass { integer 'Целое число' }
newAttribute(AttributeClass c) + WHEN c = AttributeClass.integer THEN {
    NEW a = AttributeInteger {
        edit(a);
    }
};
order(AttributeClass c) += WHEN c == AttributeClass.integer THEN 2;
id 'Код' = DATA STRING[10] (AttributeInteger) NONULL CHARWIDTH 10 IN id;
inactive 'Выкл.' = DATA BOOLEAN (AttributeInteger);
name 'Наименование' = DATA STRING[50] (AttributeInteger) NONULL IN id;
id (AttributeInteger a) += id(a);
active (AttributeInteger a) += a IS AttributeInteger AND NOT inactive(a);
name (AttributeInteger a) += name(a);
value 'Значение' = DATA INTEGER (Item, AttributeInteger);
value (Item o, AttributeInteger a) += STRING(value(o, a));

// Дополнительные ограничения
notMore 'Не больше' = DATA INTEGER (AttributeInteger);
CONSTRAINT SETCHANGED(value(Item o, AttributeInteger i)) AND value(o, i) > notMore(i) 
    MESSAGE CONCAT ' ','Значение атрибута больше чем максимально допустимое';

notLess 'Не меньше' = DATA INTEGER (AttributeInteger);
CONSTRAINT SETCHANGED(value(Item o, AttributeInteger i)) AND value(o, i) < notLess(i) 
    MESSAGE CONCAT ' ','Значение атрибута меньше чем минимально допустимое';
edit (Item o, AttributeInteger a) + {
    INPUT i = INTEGER DO {
        value(o, a) <- i;
    }
}
set (Item o, AttributeInteger a, STRING v) + {
    value(o, a) <- INTEGER(v);
}
FORM attributeInteger 'Атрибут (целое)'
    OBJECTS attr = AttributeInteger PANEL
    PROPERTIES (attr) id, name, inactive, notMore, notLess
    EDIT AttributeInteger OBJECT attr
;
DESIGN attributeInteger {
    caption = CONCAT ' - ', 'Атрибут (целое)', name(attr);
    OBJECTS {
        NEW constaraints {
            caption = 'Ограничения';
            horizontal = TRUE;
            MOVE PROPERTY(notLess(attr)) { align = START; }
            MOVE PROPERTY(notMore(attr)) { align = START; }
        }
    }
}

//------------------------------------ NUMERIC ---------------------------------------------------------------------//

CLASS AttributeNumeric 'Числовой атрибут' : Attribute;
EXTEND CLASS AttributeClass { numeric 'Число' }
newAttribute(AttributeClass c) + WHEN c = AttributeClass.numeric THEN {
    NEW a = AttributeNumeric {
        edit(a);
    }
};
order(AttributeClass c) += WHEN c == AttributeClass.numeric THEN 3;
id 'Код' = DATA STRING[10] (AttributeNumeric) NONULL CHARWIDTH 10 IN id;
inactive 'Выкл.' = DATA BOOLEAN (AttributeNumeric);
name 'Наименование' = DATA STRING[50] (AttributeNumeric) NONULL IN id;
id (AttributeNumeric a) += id(a);
active (AttributeNumeric a) += a IS AttributeNumeric AND NOT inactive(a);
name (AttributeNumeric a) += name(a);
value 'Значение' = DATA NUMERIC (Item, AttributeNumeric);
value (Item o, AttributeNumeric a) += STRING(value(o, a));
// Дополнительные ограничения
notMore 'Не больше' = DATA NUMERIC (AttributeNumeric);
CONSTRAINT SETCHANGED(value(Item o, AttributeNumeric i)) AND value(o, i) > notMore(i) 
    MESSAGE CONCAT ' ','Значение атрибута больше чем максимально допустимое';

notLess 'Не меньше' = DATA NUMERIC (AttributeNumeric);
CONSTRAINT SETCHANGED(value(Item o, AttributeNumeric i)) AND value(o, i) < notLess(i) 
    MESSAGE CONCAT ' ','Значение атрибута меньше чем минимально допустимое';

precision 'Точность' = DATA INTEGER (AttributeNumeric);
scale 'Масштаб' = DATA INTEGER (AttributeNumeric);
CONSTRAINT SET(scale(AttributeNumeric a) >= precision(a)) 
    MESSAGE 'Масштаб атрибута должен быть меньше точности';

CONSTRAINT SETCHANGED(value(Item o, AttributeNumeric n)) AND abs(value(o, n)) * power(10, scale(n)) >= NUMERIC(power(10, precision(n))) 
    MESSAGE CONCAT ' ','Точность атрибута больше чем минимально допустимая точность';
CONSTRAINT SETCHANGED(value(Item o, AttributeNumeric n)) AND floor(abs(value(o, n)) * power(10, scale(n))) != abs(value(o, n)) * power(10, scale(n))
    MESSAGE CONCAT ' ','Масштаб атрибута выше чем максимальный масштаб';

edit (Item o, AttributeNumeric a) + {
    INPUT i = NUMERIC DO {
        value(o, a) <- i;
    }
}
set (Item o, AttributeNumeric a, STRING v) + {
    value(o, a) <- NUMERIC(v);
}
FORM attributeNumeric 'Атрибут (число)'
    OBJECTS attr = AttributeNumeric PANEL
    PROPERTIES (attr) id, name, inactive, precision, scale, notMore, notLess
    EDIT AttributeNumeric OBJECT attr
;
DESIGN attributeNumeric {
    caption = CONCAT ' - ', 'Атрибут (число)', name(attr);
    OBJECTS {
        NEW constaraints {
            caption = 'Ограничения';
            horizontal = TRUE;
            MOVE PROPERTY(precision(attr)) { align = START; }
            MOVE PROPERTY(scale(attr)) { align = START; }
            MOVE PROPERTY(notLess(attr)) { align = START; }
            MOVE PROPERTY(notMore(attr)) { align = START; }
        }
    }
}

//------------------------------------ Цвет ------------------------------------------------------------------------//

CLASS AttributeColor 'Цвет' : Attribute;
EXTEND CLASS AttributeClass { color 'Цвет' }
newAttribute(AttributeClass c) + WHEN c = AttributeClass.color THEN {
    NEW a = AttributeColor {
        edit(a);
    }
};

order(AttributeClass c) += WHEN c == AttributeClass.color THEN 4;
id 'Код' = DATA STRING[10] (AttributeColor) NONULL CHARWIDTH 10 IN id;
inactive 'Выкл.' = DATA BOOLEAN (AttributeColor);
name 'Наименование' = DATA STRING[50] (AttributeColor) NONULL IN id;
id (AttributeColor a) += id(a);
active (AttributeColor a) += a IS AttributeColor AND NOT inactive(a);
isObject (AttributeColor a) += a IS AttributeColor;
name (AttributeColor a) += name(a);

FORM dialogAttributeColorValue 'Значение атрибута'
// для плоского списка    
//    OBJECTS attr = AttributeColor PANEL, val = Color
//    PROPERTIES(val) READONLY name
    
    OBJECTS attr = AttributeColor PANEL    
    TREE treeColors val=Color PARENT parent(val)
    PROPERTIES READONLY name(val), color 'Цвет' = nameParent(val)
    ORDERS name(val) 
;
DESIGN dialogAttributeColorValue {
    caption = CONCAT ' - ', 'Значение атрибута', name(attr);
}

value 'Значение' = DATA Color (Item, AttributeColor);
value (Item o, AttributeColor a) += STRING(OVERRIDE name(value(o, a)), 'Без наименования' IF value(o, a));
objectValue (Item o, AttributeColor a) += value(o, a);
colorAttribute (STRING id) = GROUP MAX Color c AS Color BY [FORMULA STRING '$1::text'](c);

edit (Item o, AttributeColor a) + {
    IF notNull(itemSubGroup(o), a) THEN {
        DIALOG dialogAttributeColorValue OBJECTS attr = a, val INPUT DO {
            value(o, a) <- val;
        }
    } ELSE {
        DIALOG dialogAttributeColorValue OBJECTS attr = a, val INPUT NULL DO {
            value(o, a) <- val;
        }
    }
}
set (Item o, AttributeColor a, STRING v) + {
    value(o, a) <- colorAttribute(v);
}

FORM attributeColor 'Атрибут (цвет)'
    OBJECTS attr = AttributeColor PANEL
    PROPERTIES (attr) id, name, inactive
    EDIT AttributeColor OBJECT attr
;
DESIGN attributeColor { 
    caption = CONCAT ' - ', 'Атрибут (цвет)', name(attr); 
}

CLASS ItemAttribute 'Атрибут товара';
id 'Код' = DATA STRING (ItemAttribute);
itemAttributeId (id) = GROUP AGGR ItemAttribute a BY id(a);
name 'Наименование' = DATA STRING (ItemAttribute);
unitName 'Ед.измерения' = DATA STRING (ItemAttribute);
required 'Обязательный' = DATA BOOLEAN (ItemAttribute);


