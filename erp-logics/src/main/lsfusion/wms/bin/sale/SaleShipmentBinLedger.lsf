MODULE SaleShipmentBinLedger;

REQUIRE SaleShipment, Item, BinLedger, SaleBinLedger;

NAMESPACE Sale;

@defineDocumentBins(shipment, out, ' (из)');
@defineInvoiceShipmentBins(supplierStock, out, ' (из)');

@deriveInvoiceBins(outBin, outBin, supplierStock);

//ограничиваем только пользовательским классом, т.к. перемещение между ячейками может создавать отгрузку через агрегацию, что приводи к задвоению перемещения между ячейками
CONSTRAINT (CHANGED(operation(UserInvoiceDetail d)) OR DROPPED(outBin(d)) OR SET(d IS UserInvoiceDetail)) AND NOT outBin(d) AND needOut(operation(d)) AND d IS UserInvoiceDetail
    MESSAGE '"Ячейка (из)" обязательна для заданной операции списания';

//ограничиваем только пользовательским классом, т.к. перемещение между ячейками может создавать отгрузку через агрегацию, что приводи к задвоению перемещения между ячейками
CONSTRAINT (CHANGED(operation(UserShipmentDetail d)) OR DROPPED(outBin(d)) OR SET(d IS UserShipmentDetail)) AND NOT outBin(d) AND needOut(operation(d)) AND d IS UserShipmentDetail
    MESSAGE '"Ячейка (из)" обязательна для заданной операции списания';

@implementAggregationBinLedger(shipmentDetail, shipment, Shipment, sku, quantity, supplierStock);
@implementBinLedger(shipmentBinLedger, shipmentDetail, sku, quantity, supplierStock, outBin);
needToCreateShipmentBinLedger(ShipmentDetail detail) += TRUE IF outBin(detail);