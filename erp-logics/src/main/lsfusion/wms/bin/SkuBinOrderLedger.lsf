MODULE SkuBinOrderLedger;

REQUIRE BinSkuLedger, OrderLedger, SaleBinLedger;

NAMESPACE Bin;

@defineBinAttribute(orderLedger, 'Резерв');

CLASS BinSkuOrderLedger 'Резерв в ячейке' : OrderLedger;
TABLE binSkuOrderLedger (BinSkuOrderLedger);

skipBinSkuOrderLedger = ABSTRACT BOOLEAN ();
binOrderLedger = AGGR BinSkuOrderLedger WHERE currentBalance(Sku sku, Bin bin) AND orderLedger(bin) AND NOT skipBinSkuOrderLedger() MATERIALIZED INDEXED;

stock[OrderLedger] (BinSkuOrderLedger ledger) += stock(bin(ledger));
dateTime (BinSkuOrderLedger ledger) += dateTimeLastMoved(sku(ledger), bin(ledger));
isPosted (BinSkuOrderLedger ledger) += TRUE IF ledger IS BinSkuOrderLedger;
sku (BinSkuOrderLedger ledger) += sku(ledger);
description (BinSkuOrderLedger ledger) += STRING[200]('Резерв ячейки: ' + canonicalId(bin(ledger)));
quantity (BinSkuOrderLedger ledger) += currentBalance(sku(ledger), bin(ledger));
toShipQuantity (BinSkuOrderLedger ledger) += currentBalance(sku(ledger), bin(ledger));

//Делается для предотвращения попадания подготовленного к отгурзке товара в новые заказы
CONSTRAINT SET(storage(Bin bin) AND shipping(bin) AND NOT orderLedger(bin))
    MESSAGE 'Нельзя ставить признаки хранения и отгрузки для ячейки без признака резерва';