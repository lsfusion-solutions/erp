MODULE BatchReceivingSaleReturnInvoiceBinLedger;

REQUIRE ReceivingSaleReturnInvoiceBinLedger, BatchReceivingInvoiceBinLedger;

NAMESPACE SaleReturn;

overCreateDetail(ReceivingDetail d, InvoiceDetail detail) + {
    expiryDate(d) <- expiryDate(detail);
    consolidationKey(d) <- consolidationKey(detail);
}

skipReceiving(Invoice r) += NOT createShipment(r);

CONSTRAINT userReceiving(Invoice invoice) IS UserReceiving AND (NOT createShipment(invoice))
    MESSAGE 'Для накладной приемки не задана поставка';

createCreditNoteDiffInvoice(Invoice i) + {
    IF NOT userCreditNote(CONCAT '_', 'I', seriesNumber(i), date(i), idSupplierStock(i), idCustomerStock(i)) THEN NEW c = UserCreditNote {
        id(c) <- CONCAT '_', 'I', seriesNumber(i), date(i), idSupplierStock(i), idCustomerStock(i);
        operation(c) <- operation(i);
        executeLocalEvents('SaleReturn.userCreditNote');
        supplier(c) <- supplier(i);
        supplierStock(c) <- supplierStock(i);
        customer(c) <- customer(i);
        customerStock(c) <- customerStock(i);
        date(c) <- currentDate();
        time(c) <- currentTime();
        isPosted(c) <- TRUE;
    }

    FOR Receiving r =  receiving(i) AND diffInvoiceCreditNoteCompleted(Sku s, STRING str, r) AND expectedQuantity(s, str, r)
        AND InvoiceDetail d = [GROUP MAX InvoiceDetail d1 BY sku(d1), overConsolidationKey(d1), receiving(invoice(d1)), invoice(d1)](s, str, r, i)
        AND UserCreditNote c = userCreditNote(CONCAT '_', 'I', seriesNumber(d), date(d), idSupplierStock(invoice(d)), idCustomerStock(invoice(d)))
        AND NOT [GROUP MAX UserCreditNoteDetail dc1 BY creditNote(dc1), invoiceDetail(dc1)](c, d)
        DO NEW dc = UserCreditNoteDetail {
        userCreditNote(dc) <- c;
        invoiceDetail(dc) <- d;
        batch(dc) <- batch(d);
        sku(dc) <- s;
        quantity (dc) <- diffInvoiceCreditNoteCompleted(s, str, r);
        VAT (dc) <- OVERRIDE VAT(d);
        valueVAT(dc) <- OVERRIDE valueVAT(d);
        price (dc) <- price(d);
        invoicePrice (dc) <- invoicePrice(d);
    }
    executeLocalEvents('SaleReturn.userCreditNote');
}