MODULE PurchaseInvoiceTracking;

REQUIRE PurchaseInvoice, ItemTracking,  PurchaseShipment;

NAMESPACE Purchase;

isTrackingData 'Подлежит прослеживанию' = DATA BOOLEAN (Purchase.InvoiceDetail);
isTracking 'Подлежит прослеживанию' = ABSTRACT VALUE BOOLEAN (Purchase.InvoiceDetail);
isTracking (UserInvoiceDetail d) += OVERRIDE isTrackingData(d), isTrackingOver(sku(d));
dateStartSPT 'Дата начала прослеживания' (UserInvoiceDetail d)=dateStartSPT(sku(d));

isTracking(Invoice i) = GROUP SUM 1 IF isTrackingOver(sku(UserInvoiceDetail d)) AND date(d) >= dateStartSPT(d) AND invoice(d)==i;
showSPT (Invoice i)= TRUE IF isTracking(i);

idShippingDocument 'Код сопроводительного документа' = DATA STRING[20](UserInvoice);
nameShippingDocument 'Наименование сопроводительного документа' = DATA STRING[40](UserInvoice);
dateShippingDocument 'Дата сопроводительного документа' = DATA DATE (UserInvoice);
numberShippingDocument 'Регистрационный номер сопроводительного документа' = DATA STRING[40](UserInvoice);

@defineOperationProperty(importEAEU, 'Импорт из ЕАЭС', showContainer);

showImportEAEU (Invoice i) = TRUE  IF importEAEU(operation(i));
countrySupplier 'Страна грузоотправителя' (Invoice i) = name(country(supplier(i)));
idCountrySupplier 'Код страны' (Invoice i) = sidOrigin2(country(supplier(i)));
isImportEAEU 'Импорт из ЕАЭС' (Invoice i) = TRUE IF (importEAEU(operation(i)) AND (idCountrySupplier(i) == 'RU' OR idCountrySupplier(i) == 'KG'
    OR idCountrySupplier(i) == 'AM' OR idCountrySupplier(i) == 'KZ') );
notImportEAEU (Invoice i) = TRUE IF i IS Invoice AND NOT isImportEAEU(i);

EXTEND FORM userInvoice
    OBJECTS d6 = UserInvoiceDetail GRID
    PROPERTIES (d6) SHOWIF showSPT(i) READONLY dateStartSPT
    PROPERTIES (i) SHOWIF (showSPT(i) AND showImportEAEU(i)) idShippingDocument, nameShippingDocument, numberShippingDocument, dateShippingDocument
    PROPERTIES (i) SHOWIF (showSPT(i) AND showImportEAEU(i)) isImportEAEU, countrySupplier READONLY, idCountrySupplier READONLY
    FILTERS userInvoice(d6) == i, isTracking(d6)

;

DESIGN userInvoice{
    specificationBox {
        NEW sptContainer {
            caption = 'Прослеживание';
            NEW headerCertificateContainer {
                horizontal = TRUE;
                caption = 'Сопроводительный документ';
                MOVE PROPERTY(idShippingDocument(i)) { caption='Код';}
                MOVE PROPERTY(nameShippingDocument(i)) { caption='Наименование';}
                MOVE PROPERTY(numberShippingDocument(i)) { caption='Рег.№';}
                MOVE PROPERTY(dateShippingDocument(i)) { caption='Дата';}
                MOVE PROPERTY(isImportEAEU(i)) ;
                MOVE PROPERTY(countrySupplier(i)) ;
                MOVE PROPERTY(idCountrySupplier(i)) ;
            }
            MOVE BOX(d6);
        }
    }
}

EXTEND FORM userInvoice
    PROPERTIES (d) isTracking
;
EXTEND FORM invoices
    PROPERTIES (d) READONLYIF  isReadonly() isTracking
;