MODULE SaleInvoiceFuel;

REQUIRE SaleInvoice, ItemFuel, SkuLedgerFuel;

NAMESPACE Sale;

volume 'Объем, л' = ABSTRACT NUMERIC[16,5] (InvoiceDetail) CHARWIDTH 7 MATERIALIZED;
volume 'Объем, л' = DATA NUMERIC[16,5] (UserInvoiceDetail) CHARWIDTH 7;
volume (UserInvoiceDetail invoiceDetail) += volume(invoiceDetail);

density 'Плотность, кг/л' = ABSTRACT NUMERIC[8,4] (InvoiceDetail) CHARWIDTH 7 MATERIALIZED;
density 'Плотность, кг/л' = DATA NUMERIC[8,4] (UserInvoiceDetail) CHARWIDTH 7;
density (UserInvoiceDetail invoiceDetail) += density(invoiceDetail);

//volume[Invoice.InvoiceDetail](InvoiceDetail detail) += volume(detail);
CONSTRAINT CHANGED(volume(InvoiceDetail detail)) AND negativeValueInvoices() AND isFuel(skuGroup(sku(detail))) AND volume(detail) < 0
    MESSAGE 'Объем в строке накладной должен быть неотрицательным';

@fuelDensity(userInvoiceDetail, 'накладная (продажа)');

volumeInvoiceDetail 'Объем (всего), л' (invoice) = GROUP SUM volume(InvoiceDetail idetail) BY invoice(idetail) IN documentSum CHARWIDTH 8 MATERIALIZED;
volumeUserInvoiceDetail 'Объем (всего), л' (userInvoice) = GROUP SUM volume(UserInvoiceDetail idetail) BY userInvoice(idetail) IN documentSum CHARWIDTH 8 MATERIALIZED;

overBackgroundDensity =  ABSTRACT CASE COLOR (UserInvoiceDetail);

EXTEND FORM userInvoice
    PROPERTIES(i) volumeUserInvoiceDetail
    PROPERTIES(d) READONLYIF NOT isFuel(sku(d)) volume SHOWIF showQuantity(i) BACKGROUND backgroundQuantity(d) AFTER quantity(d)
    PROPERTIES(d) READONLYIF NOT isFuel(sku(d)) density AFTER volume(d) ON CHANGE changeDensity(d) ON CONTEXTMENU fillDensity15C(d) BACKGROUND overBackgroundDensity(d)
;

overCopy(UserInvoiceDetail d, InvoiceDetail detail) + {
    volume(d) <- volume(detail);
    density(d) <- density(detail);
}
overCopy[UserInvoiceDetail,UserInvoiceDetail](UserInvoiceDetail d, UserInvoiceDetail detail) + {
    volume(d) <- volume(detail);
    density(d) <- density(detail);
}

EXTEND FORM invoices
    PROPERTIES(i) READONLY BACKGROUND background(i) volumeInvoiceDetail AFTER quantityInvoiceDetail(i)
    PROPERTIES(d) READONLY volume AFTER quantity(d)
    PROPERTIES(d) READONLY density AFTER volume(d)
;

CONSTRAINT (SETCHANGED(volume(InvoiceDetail d)) OR SETCHANGED(operation(d)) OR SET(isPosted(d))) AND isFuel(skuGroup(sku(d))) AND isPosted(d) AND volume(d) < 0.0
    AND banNegativeQuantityInvoice(operation(d))
    MESSAGE 'Запрещено вводить отрицательный объем в накладную';
