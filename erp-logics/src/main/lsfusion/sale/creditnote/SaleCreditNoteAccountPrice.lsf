MODULE SaleCreditNoteAccountPrice;

REQUIRE SaleCreditNote;

NAMESPACE Sale;

accountPrice 'Цена (учетная)' = DATA NUMERIC[16,4] (UserCreditNoteDetail) CHARWIDTH 7;

CONSTRAINT accountPrice(UserCreditNoteDetail detail) < 0.0
    MESSAGE 'Учетная цена для строки акта расхождения (продажа) должна быть больше нуля';

@deriveDocumentDetailPriceAccountBatchDisable (userCreditNote, account, sku, supplierStock);

EXTEND FORM userCreditNote
    PROPERTIES(d) accountPrice, shipmentSum
;

calcShipmentSum = ABSTRACT VALUE NUMERIC[18,4] (UserCreditNoteDetail);
calcShipmentSum(UserCreditNoteDetail userCreditNoteDetail) += NUMERIC[18,4](Utils.round(quantity(userCreditNoteDetail) * accountPrice(userCreditNoteDetail), defaultRound(currency(userCreditNoteDetail))));
shipmentSum (UserCreditNoteDetail userCreditNoteDetail) <- calcShipmentSum(userCreditNoteDetail)
    WHEN DO CHANGED(quantity(userCreditNoteDetail)) OR CHANGED (accountPrice(userCreditNoteDetail)) OR CHANGED(currency(userCreditNoteDetail));

